<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>More complex mapping | XData website </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="More complex mapping | XData website ">
    <meta name="generator" content="docfx 2.48.0.0">
    
    <link rel="shortcut icon" href="../.././images/cube.ico">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    <meta property="docfx:rel" content="../../">
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../.././images/cube-white.png" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div class="container body-content">
        
        <div id="search-results">
          <div class="search-list"></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h2 id="more-complex-mapping">More complex mapping</h2>

<p>1) Now consider a slightly more complex mapping using the directory object as an example. Add a table with a recursive link to ourselves ...</p>
<div class="lang-plantUml" \=""> <?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentscripttype="application/ecmascript" contentstyletype="text/css" height="108px" preserveaspectratio="none" style="width:181px;height:108px;" version="1.1" viewbox="0 0 181 108" width="181px" zoomandpan="magnify"><defs><filter height="300%" id="f17c8s2uod7730" width="300%" x="-1" y="-1"><fegaussianblur result="blurOut" stddeviation="2.0"></fegaussianblur><fecolormatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"></fecolormatrix><feoffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"></feoffset><feblend in="SourceGraphic" in2="blurOut3" mode="normal"></feblend></filter></defs><g><!--MD5=[957235e470c5a75c0bcb7e32f4b6bfa6]
class t_catalog--><rect fill="#FFFFFF" filter="url(#f17c8s2uod7730)" height="91.1875" id="t_catalog" style="stroke: #000000; stroke-width: 1.0;" width="82.3333" x="6" y="6"></rect><rect fill="#D3D3D3" height="23.9688" style="stroke: #000000; stroke-width: 1.0;" width="82.3333" x="6" y="6"></rect><text fill="#000000" font-family="sans-serif" font-size="12" lengthadjust="spacingAndGlyphs" textlength="54" x="20.1667" y="22.1387">t_catalog</text><line style="stroke: #000000; stroke-width: 1.5;" x1="7" x2="87.3333" y1="29.9688" y2="29.9688"></line><path d="M18.0417,36.6901 C16.7767,36.6901 15.75,37.7168 15.75,38.9818 C15.75,39.1284 15.7802,39.254 15.8078,39.3833 L13,42.191 L13,44.0244 L15.75,44.0244 L15.75,42.191 L17.5833,42.191 L17.5833,41.2744 L17.6411,41.2166 C17.7694,41.2441 17.895,41.2744 18.0426,41.2744 C19.3076,41.2744 20.3342,40.2477 20.3342,38.9827 C20.3342,37.7177 19.3076,36.691 18.0426,36.691 M18.5009,37.6077 C19.0051,37.6077 19.4176,38.0202 19.4176,38.5244 C19.4176,39.0285 19.0051,39.441 18.5009,39.441 C17.9968,39.441 17.5843,39.0285 17.5843,38.5244 C17.5843,38.0202 17.9968,37.6077 18.5009,37.6077 " fill="#000000" style="stroke: ; stroke-width: 0.0; stroke-dasharray: ;"></path><text fill="#000000" font-family="sans-serif" font-size="11" lengthadjust="spacingAndGlyphs" textlength="57" x="25.3333" y="44.1792">catalog_id</text><line style="stroke: #000000; stroke-width: 1.0;" x1="7" x2="87.3333" y1="50.7734" y2="50.7734"></line><path d="M17.5833,58.4115 L14.8333,63.9115 L15.75,63.9115 L18.5,58.4115 L17.5833,58.4115 M13.9167,59.3281 L13,61.1615 L13.9167,62.9948 L14.8333,62.9948 L13.9167,61.1615 L14.8333,59.3281 L13.9167,59.3281 M18.5,59.3281 L19.4167,61.1615 L18.5,62.9948 L19.4167,62.9948 L20.3333,61.1615 L19.4167,59.3281 L18.5,59.3281 " fill="#000000" style="stroke: ; stroke-width: 0.0; stroke-dasharray: ;"></path><text fill="#000000" font-family="sans-serif" font-size="11" lengthadjust="spacingAndGlyphs" textlength="28" x="25.3333" y="64.9839">code</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthadjust="spacingAndGlyphs" textlength="33" x="12" y="77.7886">name</text><path d="M16.6667,83.1042 C14.6408,83.1042 13,84.745 13,86.7708 C13,88.7967 14.6408,90.4375 16.6667,90.4375 C18.6925,90.4375 20.3333,88.7967 20.3333,86.7708 C20.3333,84.745 18.6925,83.1042 16.6667,83.1042 M16.6667,84.0208 L19.4167,86.7708 L16.6667,89.5208 L16.6667,87.6875 L13.9167,87.6875 L13.9167,85.8542 L16.6667,85.8542 L16.6667,84.0208 " fill="#000000" style="stroke: ; stroke-width: 0.0; stroke-dasharray: ;"></path><text fill="#000000" font-family="sans-serif" font-size="11" lengthadjust="spacingAndGlyphs" textlength="0" x="25.3333" y="90.5933"></text><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthadjust="spacingAndGlyphs" textlength="53" x="25.3333" y="90.5933">parent_id</text><!--MD5=[9e57ba7a659eb57cc2ff8d3e32c5b298]
link t_catalog to t_catalog--><path d="M88.0461,34.9227 C106.745,33.2301 123,38.7559 123,51.5 C123,62.3524 111.213,67.9704 96.1663,68.3539 " fill="none" id="t_catalog-&gt;t_catalog" style="stroke: #000000; stroke-width: 1.0;"></path><line style="stroke: #000000; stroke-width: 1.0;" x1="96.0415" x2="88.0461" y1="68.3497" y2="76.0727"></line><line style="stroke: #000000; stroke-width: 1.0;" x1="96.0415" x2="88.0461" y1="68.3497" y2="60.0819"></line><line style="stroke: #000000; stroke-width: 1.0;" x1="96.0415" x2="88.0461" y1="68.3497" y2="68.0773"></line><text fill="#000000" font-family="sans-serif" font-size="8" lengthadjust="spacingAndGlyphs" textlength="40" x="129" y="53.9258">parent_id</text><!--MD5=[09e21257042b0fbf55fdd9699152ae5d]
@startuml


hide circle
skinparam ClassHeaderBackgroundColor lightgray
skinparam ClassBorderColor black
skinparam ClassBorderThickness 1
skinparam ClassBackgroundColor transparrent
skinparam ArrowFontSize 8
skinparam ArrowColor black

entity t_catalog
{
   <&key> catalog_id
   - -
   <&code> code
   name
   <&arrow-circle-right> //parent_id//
}
t_catalog - -{ t_catalog : parent_id
@enduml

PlantUML version 1.2020.12(Sat Jun 06 10:54:15 UTC 2020)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg> </div><p>2) Add <em>Model</em> class <em>Catalog.cs</em> in a <em>Models</em> folder...</p>
<pre><code class="lang-csharp">using XData;
using XData.Mapping;

namespace &lt;..Your namespace..&gt;.Models
{
    public partial class Catalog
    {
        public long CatalogId =&gt; this.GetProperty(x =&gt; x.CatalogId);
        public string Code { get; set; }
        public string Name { get; set; }
        public Link&lt;string, Catalog&gt; Parent { get; set; }
    }
}
</code></pre><p>3) Here, the type of the property <em>Parent</em> will be new to us. It is used in XData to describe an external reference to a dictionary or other entity. And here is a slightly more specific case - a tree reference to oneself. The description type of such a link is <a class="xref" href="../../api/XData.Mapping.Link-2.html">Link&lt;TVal,TSource&gt;</a> and it is typed by the type of value that will be in the <a class="xref" href="../../api/XData.Mapping.Link-2.html#XData_Mapping_Link_2_Value">Value</a> property of <em>Link</em> and the type of entity to which we refer (in this case, our type - <em>Catalog</em>). In our case <em>Value</em> of <em>Link</em> is the unique <em>Code</em> of the parent entity. See <a href="../../tutorial/mapping/dynamic/dynamic.html#links">documentation topic</a> for more details</p>
<p>4) Add class <em>Catalog.xdata.cs</em> in a <em>Models</em> folder and define mapping...</p>
<pre><code class="lang-csharp">using System.Linq.Expressions;
using XData;
using XData.Mapping.Dynamic;

namespace &lt;..Your namespace..&gt;.Models
{
    public partial class Catalog : IDataObject
    {
        // ReSharper disable once UnusedMember.Local
        private static Expression&lt;CustomMapping&lt;Catalog&gt;&gt; _ =
            () =&gt; XDataMapping.CustomMapping&lt;Catalog&gt;()
                .DataTable(&quot;T_CATALOG&quot;, &quot;C&quot;)
                .DataTable(&quot;T_CATALOG&quot;, &quot;P&quot;, 
                    x =&gt; x.Link(&quot;C&quot;, &quot;parent_id&quot;, &quot;catalog_id&quot;)
                        .SetOperation(FilterOperation.OuterJoin))
                .Column(&quot;ParentId&quot;, x =&gt; x.Field&lt;long?&gt;(&quot;C&quot;, string.Empty))
                .ReadOnlyProperty(x =&gt; x.CatalogId,
                    x =&gt; x.Field&lt;long&gt;(&quot;C&quot;, string.Empty, z =&gt; z.Key(), 
                        z =&gt; z.Default(DefaultType.AutoIncrement)))
                .Map(x =&gt; new Catalog
                {
                    Code = x.Field&lt;string&gt;(&quot;C&quot;, string.Empty),
                    Name = x.Field&lt;string&gt;(&quot;C&quot;, string.Empty),
                    Parent = x.Link&lt;string, Catalog&gt;(&quot;P&quot;, &quot;code&quot;, z =&gt; z.OuterFlag(), 
                        z =&gt; z.LinkProperty((Catalog y) =&gt; y.Code), 
                        z =&gt; z.LinkProperty&lt;Catalog&gt;(y =&gt; y.CatalogId, 
                            y =&gt; y.GetProperty&lt;long?&gt;(&quot;ParentId&quot;)))
                }).SetBaseTable(&quot;C&quot;);
    }
}
</code></pre><p>5) The first mention of the <a class="xref" href="../../api/XData.Mapping.Dynamic.IRepositoryStructure-1.html#XData_Mapping_Dynamic_IRepositoryStructure_1_DataTable_System_String_System_String_System_Linq_Expressions_Expression_System_Func_XData_Mapping_Dynamic_IInnerFilterAdapter_XData_Mapping_Dynamic_IFilterDescription_____">DataTable</a> method is similar to what we have already seen, but the second is more interesting, we describe the same table under a different alias &quot;P&quot; and also describe its relationship with the first table. This is indicated by the alias &quot;C&quot; as the first parameter of the <a class="xref" href="../../api/XData.Mapping.Dynamic.IInnerFilterAdapter.html#XData_Mapping_Dynamic_IInnerFilterAdapter_Link_System_String_System_String_System_String_">Link</a> method, the second parameter denotes the field name of the linked table &quot;C&quot; and the third field name of the current table (with the &quot;P&quot; alias). If the names of the related fields are the same, another overload of this method is used which allows you to specify the field name once. See <a href="../../tutorial/mapping/dynamic/dynamic.html#inner-links">documentation topic</a> for more details</p>
<p>6) By default, the connection has the operation &quot;equal&quot;, but in this case we need to link these tables by the outer join join and to indicate this we &quot;refine&quot; the link using the <a class="xref" href="../../api/XData.Mapping.Dynamic.QueryDescriptionExtensions.html#XData_Mapping_Dynamic_QueryDescriptionExtensions_SetOperation__1___0_XData_FilterOperation_">SetOperation</a> method and specify the operation <a class="xref" href="../../api/XData.FilterOperation.html">FilterOperation.OuterJoin</a>. See <a href="../../tutorial/mapping/dynamic/dynamic.html#filters">documentation topic</a> for more details</p>
<p>7) For now, skip the <em>Column</em> method and return to it later...</p>
<p>8) The next new element for us will be a description of the mapping of the &quot;Parent&quot; link field. It is described by the <a class="xref" href="../../api/XData.Mapping.Dynamic.IRepositoryStructureAdapter-1.html#XData_Mapping_Dynamic_IRepositoryStructureAdapter_1_Link__2_System_String_System_Linq_Expressions_Expression_System_Func_XData_Mapping_Dynamic_ILinkPropertyMappingAdapter__0__XData_Mapping_Dynamic_IStructureFlag_____">Link&lt;TVal,TSource&gt;</a> method typed as the type of the property in the main description of the object. The first parameter is the data source alias (&quot;P&quot;) of the field that will be assigned in link <em>Value</em>, the second parameter designates the field that will be assigned in <em>Value</em>. The third parameter contains the lambda-modifiers assigned to the link field ... </p>
<p>9) The first modifier <a class="xref" href="../../api/XData.Mapping.Dynamic.IRepositoryReadOnlyPropertyMappingAdapter.html#XData_Mapping_Dynamic_IRepositoryReadOnlyPropertyMappingAdapter_OuterFlag">OuterFlag</a> shows that this field is an indicator of whether or not to insert an entry into the table connected by the outer join (when inserting). If value is null inserting to this table (and their child tables in updatable tables hierarchy) will be skipped. When updating to an empty value, it signals the need to delete the record from the table optionally connected and their child tables in updatable tables hierarchy. See <a href="../../tutorial/mapping/dynamic/dynamic.html#properties">documentation topic</a> for more details</p>
<p>10) The rest of the modifiers describe which fields will be copied when assigning the link from the source object. There are few overloads of the <a class="xref" href="../../api/XData.Mapping.Dynamic.ILinkPropertyMappingAdapter-1.html#XData_Mapping_Dynamic_ILinkPropertyMappingAdapter_1_LinkProperty">LinkProperty</a> method:</p>
<ul>
<li>with one lambda parameter that takes a link type parameter (in our case, the first occurrence). It determines which property of the link object will be copied to <em>Value</em></li>
<li>with no parameters (in our case this does not occur). It determines property of the link object will be copied to <em>Value</em> named the same as link property</li>
<li>with one lambda parameter that takes a parameter of the type of the object being edited (in our case this does not occur). It means copying to the specified property from the property of the link object with the same name</li>
<li>with two parameters (second occurrence). The first parameter is the copy source, the second is the target...</li>
</ul>
<p>11) The last parameter needs to be considered especially. It is specified using the <a class="xref" href="../../api/XData.DataObjectExtensions.html#XData_DataObjectExtensions_GetProperty__1_XData_IDataObject_System_String_">GetProperty</a> method with the string parameter &quot;ParentId&quot;. Note that this coincides with the first parameter of the <a class="xref" href="../../api/XData.Mapping.Dynamic.IRepositoryStructure-1.html#XData_Mapping_Dynamic_IRepositoryStructure_1_Column__1_System_String_System_Linq_Expressions_Expression_System_Func_XData_Mapping_Dynamic_IRepositoryStructureAdapter__0____0___">Column</a> method we skipped. Using this method, a hidden field is described that is necessary only for mapping and not displayed on the properties of the described object. And therefore, the <em>CatalogId</em> property of the source will be copied to a hidden property named &quot;ParentId&quot;. See <a href="../../tutorial/mapping/dynamic/dynamic.html#hidden-properties">documentation topic</a> for more details</p>
<p>12) Web API controller for this object will look like...</p>
<pre><code class="lang-csharp">using XData;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using &lt;..Youre namespace..&gt;.Models;

namespace &lt;..Youre namespace..&gt;.Controllers.API
{
    public class CatalogController : DataObjectController&lt;Catalog&gt;
    {
        public CatalogController(IDataEngine dataEngine) : base(dataEngine) { }

        [HttpGet]
        public async Task&lt;ActionResult&lt;Catalog&gt;&gt; Get(long id, CancellationToken cancellationToken)
        {
            try
            {
                using (var dataScope = _dataEngine.NewDataScope(cancellationToken))
                {
                    return await dataScope.GetRepository&lt;Catalog&gt;()
                        .SingleOrDefaultAsync(x =&gt; x.CatalogId == id);
                }
            }
            catch (Exception e)
            {
                e.FillModelState(ModelState);
                throw;
            }
        }

        [HttpGet]
        public async Task&lt;ActionResult&lt;Catalog[]&gt;&gt; GetChilds(long id, CancellationToken cancellationToken)
        {
            try
            {
                using (var dataScope = _dataEngine.NewDataScope(cancellationToken))
                {
                    if(id == 0) //return root catalogs
                        return await dataScope.GetRepository&lt;Catalog&gt;()
                            .Where(x =&gt; x.GetProperty&lt;object&gt;(&quot;ParentId&quot;) == null)
                            .ToArrayAsync();
                    return await dataScope.GetRepository&lt;Catalog&gt;()
                        .Where(x =&gt; x.GetProperty&lt;long&gt;(&quot;ParentId&quot;) == id)
                        .ToArrayAsync();
                }
            }
            catch (Exception e)
            {
                e.FillModelState(ModelState);
                throw;
            }
        }
    }
}
</code></pre><div class="TIP"><h5>Tip</h5><p>An attentive reader will certainly notice that this implementation does not have protection against directory tree loops. This can be done using XData, but this will unnecessarily complicate the example of this lesson.</p>
</div>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/mickfierte/private/blob/main/doc/quick_start/asp_net_core/mapping_two.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            
            <span>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
