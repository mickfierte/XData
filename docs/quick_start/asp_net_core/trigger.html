<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Trigger logic | XData website </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Trigger logic | XData website ">
    <meta name="generator" content="docfx 2.48.0.0">
    
    <link rel="shortcut icon" href="../.././images/cube.ico">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    <meta property="docfx:rel" content="../../">
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../.././images/cube-white.png" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div class="container body-content">
        
        <div id="search-results">
          <div class="search-list"></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h2 id="trigger-logic">Trigger logic</h2>

<p>When a task arises of maintaining information that is not directly related to the business logic of the application, for example, an audit task, it is convenient to take out the code leading the tracking of such information and store it separately from the main application code. Moreover, it usually does not require user input. Nevertheless, it is often necessary to conduct an audit. The task given here is somewhat degenerate, but nevertheless it is simple and explains the essence of the approach, which is important for training.</p>
<p>In addition, in the course of a closer acquaintance with this mechanism, you will be able to discover not obvious aspects of its use and will be able to evaluate its significance in a new way.</p>
<p>1) Let&#39;s start as always with the database...</p>
<div class="lang-plantUml" \=""> <?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentscripttype="application/ecmascript" contentstyletype="text/css" height="118px" preserveaspectratio="none" style="width:405px;height:118px;" version="1.1" viewbox="0 0 405 118" width="405px" zoomandpan="magnify"><defs><filter height="300%" id="fd0np8szrz5xv" width="300%" x="-1" y="-1"><fegaussianblur result="blurOut" stddeviation="2.0"></fegaussianblur><fecolormatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"></fecolormatrix><feoffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"></feoffset><feblend in="SourceGraphic" in2="blurOut3" mode="normal"></feblend></filter></defs><g><!--MD5=[5ea577eca533bfca935d04f775d3f167]
class t_doc--><rect fill="#FFFFFF" filter="url(#fd0np8szrz5xv)" height="39.9688" id="t_doc" style="stroke: #000000; stroke-width: 1.0;" width="40" x="354.5" y="37.5"></rect><rect fill="#D3D3D3" height="23.9688" style="stroke: #000000; stroke-width: 1.0;" width="40" x="354.5" y="37.5"></rect><text fill="#000000" font-family="sans-serif" font-size="12" lengthadjust="spacingAndGlyphs" textlength="34" x="357.5" y="53.6387">t_doc</text><line style="stroke: #000000; stroke-width: 1.0;" x1="355.5" x2="393.5" y1="61.4688" y2="61.4688"></line><line style="stroke: #000000; stroke-width: 1.0;" x1="355.5" x2="393.5" y1="69.4688" y2="69.4688"></line><!--MD5=[4efa0cfa5e1d38a4afda4e219b98680a]
class t_doc_state--><rect fill="#FFFFFF" filter="url(#fd0np8szrz5xv)" height="39.9688" id="t_doc_state" style="stroke: #000000; stroke-width: 1.0;" width="79" x="6" y="37.5"></rect><rect fill="#D3D3D3" height="23.9688" style="stroke: #000000; stroke-width: 1.0;" width="79" x="6" y="37.5"></rect><text fill="#000000" font-family="sans-serif" font-size="12" lengthadjust="spacingAndGlyphs" textlength="73" x="9" y="53.6387">t_doc_state</text><line style="stroke: #000000; stroke-width: 1.0;" x1="7" x2="84" y1="61.4688" y2="61.4688"></line><line style="stroke: #000000; stroke-width: 1.0;" x1="7" x2="84" y1="69.4688" y2="69.4688"></line><!--MD5=[0d4a222ed2d2d268b8328f05b8f9e363]
class t_doc_history--><rect fill="#FFFFFF" filter="url(#fd0np8szrz5xv)" height="99.1875" id="t_doc_history" style="stroke: #000000; stroke-width: 1.0;" width="107.3333" x="181" y="8"></rect><rect fill="#D3D3D3" height="23.9688" style="stroke: #000000; stroke-width: 1.0;" width="107.3333" x="181" y="8"></rect><text fill="#000000" font-family="sans-serif" font-size="12" lengthadjust="spacingAndGlyphs" textlength="82" x="193.6667" y="24.1387">t_doc_history</text><line style="stroke: #000000; stroke-width: 1.5;" x1="182" x2="287.3333" y1="31.9688" y2="31.9688"></line><path d="M193.0417,38.6901 C191.7767,38.6901 190.75,39.7168 190.75,40.9818 C190.75,41.1284 190.7803,41.254 190.8078,41.3833 L188,44.191 L188,46.0244 L190.75,46.0244 L190.75,44.191 L192.5833,44.191 L192.5833,43.2744 L192.6411,43.2166 C192.7694,43.2441 192.895,43.2744 193.0426,43.2744 C194.3076,43.2744 195.3343,42.2477 195.3343,40.9827 C195.3343,39.7177 194.3076,38.691 193.0426,38.691 M193.5009,39.6077 C194.0051,39.6077 194.4176,40.0202 194.4176,40.5244 C194.4176,41.0285 194.0051,41.441 193.5009,41.441 C192.9968,41.441 192.5843,41.0285 192.5843,40.5244 C192.5843,40.0202 192.9968,39.6077 193.5009,39.6077 " fill="#000000" style="stroke: ; stroke-width: 0.0; stroke-dasharray: ;"></path><text fill="#000000" font-family="sans-serif" font-size="11" lengthadjust="spacingAndGlyphs" textlength="82" x="200.3333" y="46.1792">doc_history_id</text><line style="stroke: #000000; stroke-width: 1.0;" x1="182" x2="287.3333" y1="52.7734" y2="52.7734"></line><path d="M191.6667,59.4948 C189.6408,59.4948 188,61.1356 188,63.1615 C188,65.1873 189.6408,66.8281 191.6667,66.8281 C193.6925,66.8281 195.3333,65.1873 195.3333,63.1615 C195.3333,61.1356 193.6925,59.4948 191.6667,59.4948 M191.6667,60.4115 L194.4167,63.1615 L191.6667,65.9115 L191.6667,64.0781 L188.9167,64.0781 L188.9167,62.2448 L191.6667,62.2448 L191.6667,60.4115 " fill="#000000" style="stroke: ; stroke-width: 0.0; stroke-dasharray: ;"></path><text fill="#000000" font-family="sans-serif" font-size="11" lengthadjust="spacingAndGlyphs" textlength="36" x="200.3333" y="66.9839">doc_id</text><path d="M191.6667,72.2995 C189.6408,72.2995 188,73.9403 188,75.9661 C188,77.992 189.6408,79.6328 191.6667,79.6328 C193.6925,79.6328 195.3333,77.992 195.3333,75.9661 C195.3333,73.9403 193.6925,72.2995 191.6667,72.2995 M191.6667,73.2161 L194.4167,75.9661 L191.6667,78.7161 L191.6667,76.8828 L188.9167,76.8828 L188.9167,75.0495 L191.6667,75.0495 L191.6667,73.2161 " fill="#000000" style="stroke: ; stroke-width: 0.0; stroke-dasharray: ;"></path><text fill="#000000" font-family="sans-serif" font-size="11" lengthadjust="spacingAndGlyphs" textlength="72" x="200.3333" y="79.7886">doc_state_id</text><line style="stroke: #000000; stroke-width: 1.0;" x1="182" x2="287.3333" y1="86.3828" y2="86.3828"></line><text fill="#000000" font-family="sans-serif" font-size="11" lengthadjust="spacingAndGlyphs" textlength="49" x="191" y="100.5933">changed</text><!--MD5=[1bc25729a460827afacde8227586a6ce]
reverse link t_doc_history to t_doc--><path d="M296.446,57.5 C317.256,57.5 339.028,57.5 354.274,57.5 " fill="none" id="t_doc_history&lt;-t_doc" style="stroke: #000000; stroke-width: 1.0;"></path><line style="stroke: #000000; stroke-width: 1.0;" x1="296.227" x2="288.227" y1="57.5" y2="65.5"></line><line style="stroke: #000000; stroke-width: 1.0;" x1="296.227" x2="288.227" y1="57.5" y2="49.5"></line><line style="stroke: #000000; stroke-width: 1.0;" x1="296.227" x2="288.227" y1="57.5" y2="57.5"></line><text fill="#000000" font-family="sans-serif" font-size="8" lengthadjust="spacingAndGlyphs" textlength="30" x="306.25" y="50.9258">doc_id</text><!--MD5=[fa5c516205306036950004734ceabedd]
link t_doc_state to t_doc_history--><path d="M85.1206,57.5 C110.549,57.5 144.089,57.5 172.945,57.5 " fill="none" id="t_doc_state-&gt;t_doc_history" style="stroke: #000000; stroke-width: 1.0;"></path><line style="stroke: #000000; stroke-width: 1.0;" x1="172.949" x2="180.949" y1="57.5" y2="49.5"></line><line style="stroke: #000000; stroke-width: 1.0;" x1="172.949" x2="180.949" y1="57.5" y2="65.5"></line><line style="stroke: #000000; stroke-width: 1.0;" x1="172.949" x2="180.949" y1="57.5" y2="57.5"></line><text fill="#000000" font-family="sans-serif" font-size="8" lengthadjust="spacingAndGlyphs" textlength="59" x="103.5" y="50.9258">doc_state_id</text><!--MD5=[61a1812eaebdd6776a00acae125d419e]
@startuml


hide circle
skinparam ClassHeaderBackgroundColor lightgray
skinparam ClassBorderColor black
skinparam ClassBorderThickness 1
skinparam ClassBackgroundColor transparrent
skinparam ArrowFontSize 8
skinparam ArrowColor black

entity t_doc
{
}

entity t_doc_state
{
}

entity t_doc_history
{
   <&key> doc_history_id
   - -
   <&arrow-circle-right> doc_id
   <&arrow-circle-right> doc_state_id
   - -
   <&lock> changed
}
t_doc -left-{ t_doc_history : doc_id
t_doc_state -right-{ t_doc_history : doc_state_id
@enduml

PlantUML version 1.2020.08beta7(Unknown compile time)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 14.0.1+7
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg> </div><p>2) We describe the new mapping of <em>DocHistory</em> the and a class of logic. It is recommended to describe the logic and related class mappings in a separate assembly. This will allow loading module as plugin...</p>
<pre><code class="lang-csharp">public partial class DocHistory
{
    public long DocId =&gt; this.GetProperty(x =&gt; x.DocId);
    public long DocStateId =&gt; this.GetProperty(x =&gt; x.DocStateId);
    public DateTime Changed { get; set; }
}
</code></pre><pre><code class="lang-csharp">public partial class DocHistory : IDataObject
{
    private static Expression&lt;CustomMapping&lt;DocHistory&gt;&gt; _ =
        () =&gt; XDataMapping.CustomMapping&lt;DocHistory&gt;()
            .DataTable(&quot;T_DOC_HISTORY&quot;, &quot;H&quot;)
            .ReadOnlyProperty(x =&gt; x.DocId, 
                x =&gt; x.Field&lt;long&gt;(&quot;H&quot;, string.Empty))
            .ReadOnlyProperty(x =&gt; x.DocStateId, 
                x =&gt; x.Field&lt;long&gt;(&quot;H&quot;, string.Empty))
            .Column(&quot;DocHistoryId&quot;, 
                x =&gt; x.Field&lt;long&gt;(&quot;H&quot;, string.Empty, z =&gt; z.Key()))
            .Map(x =&gt; new DocHistory {
                Changed = x.Field&lt;DateTime&gt;(&quot;H&quot;, string.Empty)
            }).SetBaseTable(&quot;H&quot;);
}
</code></pre><pre><code class="lang-csharp">public class InvoiceLogic : XDataLogic&lt;Invoice&gt;
{
    [Action(DataActionType.AfterInsert), Action(DataActionType.AfterUpdate)]
    public Trigger&lt;Invoice&gt; UpdateHistory =&gt; 
        ((ref Invoice invoice, ref DataTriggerFlag flag) =&gt;
    {
        if (!invoice.CheckState(DataObjectState.New) 
            &amp;&amp; !invoice.IsChanged(x =&gt; x.DocState)) return true;
        var rep = invoice.GetRepository();
        using (var hist = GetRepository&lt;DocHistory&gt;(rep.Layer, context: rep.Context))
        {
            return hist.Do(x =&gt; x.Instance.Reset()
                    .SetFilterValue&lt;DocHistory&gt;(x =&gt; x.DocId, invoice.DocId)
                    .SetFilterValue&lt;DocHistory&gt;(x =&gt; x.DocStateId, 
                        invoice.GetProperty&lt;long&gt;(&quot;DocStateId&quot;)))
                .New(x =&gt; x.Changed = DateTime.Now)
                .Submit();
        }
    });

    [Action(DataActionType.BeforeDelete)]
    public Trigger&lt;Invoice&gt; ClearHistory =&gt; 
        ((ref Invoice invoice, ref DataTriggerFlag flag) =&gt;
    {
        var i = invoice;
        using (var hist = GetRepository&lt;DocHistory&gt;(
            i.GetLayer(), context: i.GetContext()))
        {
            return hist.Reset().Clear(x =&gt; x.DocId == i.DocId));
        }
    });

    [Action(DataActionType.BeforeClear)]
    public RepositoryTrigger&lt;Invoice&gt; ClearHistoryBatch =&gt;
        ((IRepository&lt;Invoice&gt; invoiceRepository, ref DataTriggerFlag flag) =&gt;
    {
        using (var hist = GetRepository&lt;DocHistory&gt;(invoiceRepository.Layer, 
            context: invoiceRepository.Context))
        {
            return hist.Reset().Clear(x =&gt;
                invoiceRepository.Any(z =&gt; x.DocId == z.DocId));
        }
    });
}
</code></pre><p>3) The type of logic module must be inherited from the <a class="xref" href="../../api/XData.XDataLogic-1.html">XDataLogic&lt;T&gt;</a> class typed by the type of the parent data object (<em>Invoice</em>).</p>
<p>4) Inside the logic module, the properties of the delegate type are described which will be called during the processing of entities of the base type (<em>Invoice</em>). The moment of the logic call is set using the <a class="xref" href="../../api/XData.Mapping.ActionAttribute.html">Action</a> attribute to which <a class="xref" href="../../api/XData.DataActionType.html">DataActionType</a>, the type of handler, is passed as a parameter. In this case, the same handler can be assigned to several actions (this is shown by the example of the <em>UpdateHistory</em> handler). The types of delegates are different for <a class="xref" href="../../api/XData.Trigger-1.html">Trigger&lt;T&gt;</a> record-level handlers, which are triggered when changes are applied to the same object and the repository level - <a class="xref" href="../../api/XData.RepositoryTrigger-1.html">RepositoryTrigger&lt;T&gt;</a>, which are triggered by mass actions on repository objects.</p>
<p>5) It should be noted that a different <a class="xref" href="../../api/XData.XDataLogic-1.html#XData_XDataLogic_1_GetRepository__1_System_Guid_System_String_System_String_XData_Interfaces_ISecuritySession_XData_Variable___">GetRepository</a> method is used here. It takes as parameters the identifier of the layer and the database context in which the base object (and its repository) are located. This allows us to get into the context of making changes to the base object.</p>
<p>6) In addition, the <a class="xref" href="../../api/XData.IRepository-1.html#XData_IRepository_1_Reset">Reset</a> method is used here, which clears the filters assigned to the repository instance and thereby frees us from the influence of its previous use.</p>
<p>7) Our new method will be <a class="xref" href="../../api/XData.IRepository-1.html#XData_IRepository_1_Clear_System_Linq_Expressions_Expression_System_Func__0_System_Boolean___XData_DataSubmitFlag_">Clear</a>. It is used to delete all repository objects or objects that satisfy a certain condition specified when this method is called. In addition, you can configure the logic module to call a special handler before or after deleting objects using this method (as demonstrated by the <em>ClearHistoryBatch</em> delegate).</p>
<div class="IMPORTANT"><h5>Important</h5><p>It is important to understand the difference between database level triggers and these XData level triggers. A database trigger is called during changes made to the records of the table, whereas XData logic module processes the changes in the level of the data object. It must be remembered that a data object can include several database tables on the one hand (the same <em>Invoice</em> object can serve as an example here) and, on the other hand, a part of information regarding other objects can be stored in one table (for example, the <em>T_DOC</em> table will contain data not only related to the <em>Invoice</em>). And from this point of view, the value of such a mechanism inside the XData can hardly be overestimated!</p>
</div>
<p>8) We register our logic module in the IoC container. In this case, we will provide the registration code directly during the initialization of the container, but you can use more complex usage scenarios if necessary.</p>
<pre><code class="lang-csharp">public void ConfigureServices(IServiceCollection services)
{
    ...
    services.AddSingleton&lt;IDataLogic&lt;Invoice&gt;, InvoiceLogic&gt;();
    ...
}
</code></pre><pre><code class="lang-csharp">public void Configure(IApplicationBuilder app, IHostingEnvironment env)
{
    ...
    app.ApplicationServices.UseXDataDependencies();
    ...
}
</code></pre><p>9) In order to use the registration of logic modules in the IoC container, you need to call the <a class="xref" href="../../api/XData.XDataManager.html#XData_XDataManager_UseXDataDependencies_System_IServiceProvider_">UseXDataDependencies</a> method from the service provider.</p>
<div class="NOTE"><h5>Note</h5><p>Here we are considering the use of XData in ASP .Net Core. Registration of logic modules with the IoC container when .Net 4.0 version used the additional NuGet package <a href="../../index.html#nuget-packages">XData net 4.0 Inversion of Control container package</a> is required.</p>
</div>
<div class="TIP"><h5>Tip</h5><p>Note that we use the <a class="xref" href="../../api/XData.IDataLogic-1.html">IDataLogic&lt;T&gt;</a> interface typed by our data object type <em>Invoice</em> as the registration interface in the IoC container</p>
</div>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/mickfierte/private/blob/main/doc/quick_start/asp_net_core/trigger.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            
            <span>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
