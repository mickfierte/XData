### Установка и конфигурация

#### Установка
Для использования основной функциональности XData необходимо скопировать [XDataObject.dll](../../bin/) в папку с исполняемым кодом Вашего приложения и настроить ссылку (Reference) на нее из проекта Вашего приложения. Остальные модули можно подключать по мере необходимости:
- Для возможности работы с [взаимосвязанными объектами (Unit of Work)](./work_set.md) необходимо дополнительно скопировать [XDataObject.WorkSet.dll](../../bin/) и настроить ссылку (Reference) на нее из Вашего приложения.
- Для возможности использования [модели доступа к данным XData](./data_access.md) необходимо дополнительно скопировать [XDataObject.Security.dll](../../bin/) и настроить ссылку (Reference) на нее из Вашего приложения.
- Для использования любого из модулей поставляемых в исходных кодах (модули поддержки диалектов SQL, адаптеров провайдеров к той или иной БД, модулей логирования...) необходимо собрать соответствующий модуль, скопировать полученную библиотеку в папку с исполняемым кодом Вашего приложения и настроить его использование в [исходном коде](#Настройка-XData-программным-способом) или [конфигурационном файле](#Настройка-xdata-с-помощью-файла-конфигурации) Вашего приложения.
- Установка и настройка приложения для (развертывания в 3-звенной архитектуре)[./three_tier.md] детально описана ниже, в разделе ["Развертывание приложения в 3-звенной архитектуре"](#Развертывание-приложения-в-3-звенной-архитектуре).

#### Настройка XData с помощью файла конфигурации
Для настройки XData с помощью файла конфигурации Вашего приложения необходимо: 

1) Зарегистрировать секцию *xdata* в секции *configSections* указав в качестве типа секции *System.Configuration.IgnoreSectionHandler*.

>Обратите внимание, что секция *configSections* должна быть определена первой внутри секции *configuration*

```xml
<configuration>
  <configSections>
    <section name="xdata" type="System.Configuration.IgnoreSectionHandler"/>
  </configSections>
...  
```

2) Строки подключения для каждого из [контекстов](.glossary.md#Контекст) определяются в стандартной секции и должны иметь значение атрибута *name* равное имени контекста.

```xml
  <connectionStrings>
    <add name="TEST" connectionString="Data Source=(local);Initial Catalog=XDataTest;User Id=test;Password=test"/>
  </connectionStrings>
```

>Существует несколько способов обезопасить хранение строки подключения в настройках приложения:
- [Шифрование](https://msdn.microsoft.com/ru-ru/library/ms254494(v=vs.110).aspx) секции *connectionStrings*
- Использование [частичных строк подключения](./tips_and_tricks.md#Использование-частичных-строк-подключения-или-подмена-параметров-подключения-во-время-исполнения) во время исполнения
- Работа в [3-звенном режиме](./three_tier.md). В этом случае строка подключения не представлена на клиентском компьютере. Особенности настройки работы системы в 3-х звенной архитектуре развертывания описаны [ниже](#Развертывание-приложения-в-3-звенной-архитектуре).
 
3) Добавить непосредственно секцию *xdata* следующей структуры:

```xml
<xdata default="TEST_ORACLE_ODP" debug="true" log="XDataTraceLog.TraceLog, XDataTraceLog">
  <adapter name="ORACLE_ODP" assembly="XOracleODPAdapter"/>
  <dialect name="ORACLE" assembly="XOracleDialect"/>
  <context name="TEST_ORACLE_ODP" adapter="ORACLE_ODP" dialect="ORACLE" sequence="XDataObjectTest.MySequenceComposer, XDataObjectTest" concurrencyError="-20001"/>
</xdata>  
```

Секция xdata должна обязательно содержать атрибут *default* с именем [контекста](.glossary.md#Контекст) по умолчанию. Атрибут *debug* не обязательный, по умолчанию [режим отладки](./log_and_debug.md) выключен (debug = *false*). Атрибут *log* содержащий полное имя (qualified type name) класса реализующий интерфейс [*ILogWriter*](https://htmlpreview.github.io/?https://raw.githubusercontent.com/mickfierte/XData/master/docs/doc/Contents/4/370.html). Внутри секции xdata для каждого из [контекстов](.glossary.md#Контекст) должны быть определены элементы:
- **dialect** (необходим как для 2-звенной, так и для 3-звенной архитектуры) - регистрирует уникалный псевдоним для библиотеки поддержки определенного диалекта SQL. В значении атрибута *name* указывается псевдоним диалекта, а в значении атрибута *assembly* имя сборки диалекта. Если конкретная реализация библиотеки поддержки определенного диалекта SQL поддерживает настройку своих внутренних параметров элемент *dialect* может содержать специфичный для данной библитеки XML контент, который будет передан в процедуру его инициализации.
- **adapter** (необходим только для 2-звенной модели развертывания) - регистрирует уникалный псевдоним для адаптера ADO.Net провайдера. В значении атрибута *name* указывается псевдоним адаптера, а в значении атрибута *assembly* имя сборки адаптера. Если конкретная реализация адаптера поддерживает настройку своих внутренних параметров элемент *adapter* может содержать специфичный для данного адаптера XML контент, который будет передан в процедуру его инициализации.
- **context** (необходим как для 2-звенной, так и для 3-звенной архитектуры) - описывает настройки кокретного [контекста](.glossary.md#Контекст). В значении атрибута *name* указывается имя контекста, в значении атрибута *adapter* (используется только для 2-звенной модели развертывания) указывается псевдоним адаптера ADO.Net провайдера, в значении атрибута *dialect* - псевдоним библиотеки поддержки определенного диалекта SQL. В случае если для автоинкрементных полей используются счетчики (sequence) можно указать атрибут *sequence*, значением которого будет  полное имя (qualified type name) класса реализующий интерфейс [*ISequenceNameComposer*](https://htmlpreview.github.io/?https://raw.githubusercontent.com/mickfierte/XData/master/docs/doc/Contents/4/374.html). Если необходимо присвоить коду SQL ошибки нарушения [оптимистической конкуренции](./locking.md) и это поддерживает выбранный ADO.Net провайдер, то это можно сделать путем указания атрибута *concurrencyError*.
- **proxy** (необходим только для 3-звенной модели развертывания) - указывает имя клиентской точки подключения (endpoint) WCF для контекста указанного в значении атрибута *name*. Само имя клиентской точки подключения (endpoint) WCF указывается в значении атрибута *endpoint*. Одна и таже точка подключения может использоваться для нескольких контекстов. Контексты на клиентской и серверной стоороне должны иметь одинаковые имена. Детально настройка и развертывание конфигурации для 3-звенной модели описано [ниже](#Развертывание-приложения-в-3-звенной-архитектуре).

#### Настройка XData программным способом
Для настройки конфигурации XData программным способом необходимо перед первым использованием доступа к данным зарегистрировать все необходимые для работы [контексты](.glossary.md#Контекст) с помощью статического метода [**XDataManager**.*RegisterContext*](https://htmlpreview.github.io/?https://raw.githubusercontent.com/mickfierte/XData/master/docs/doc/Contents/1/413.html). Заполнение структуры [*XDataConfiguration*](https://htmlpreview.github.io/?https://raw.githubusercontent.com/mickfierte/XData/master/docs/doc/Contents/2/209.html) аналогично структуре конфигурации описанной выше в разделе ["Настройка XData с помощью файла конфигурации"](#Настройка-XData-с-помощью-файла-конфигурации)

>Обратите внимание, что с помошью этого метода можно также указать определенные части строки подключения в момент исполнения. Как воспользоваться этой возможностью детально рассмотрено [здесь](./tips_and_tricks.md#Использование-частичных-строк-подключения-или-подмена-параметров-подключения-во-время-исполнения).

#### Развертывание приложения в 3-звенной архитектуре

##### Подготовка структуры проекта к исполнению в 3-звенной архитектуре
Принципы разделения проекта на сборки которые нужны на клиентской, на серверной стороне и на обоих сторонах детально описаны в статье о [3-звенной архитектуре](./three_tier.md).

##### Установка и настройка серверной части
Серверная часть основана на использовании WCF сервиса [XAppServer.dll](../../AppServer/bin/) которое использует основную библиотеку [XDataObject.dll](../../bin/). Также потрубуются выбранные Вами модули логирования, библиотеки поддержки диалектов SQL и адаптеры ADO.Net провайдеров. Все эти библиотеки, плюс [серверные и общие модули](./three_tier.md) Вашего приложения. 

Ограничения по используемым протоколам между клиентом и сервером:
- Дуплексный протокол
- Поддержка реинтерабельности внутри одной сессии

Рекомендуется хостить сервис в Windows process Activation Service (WAS). Пример файла конфигурации для протокола net.tcp и доступа к базе данных Oracle можно посмотреть здесь: [Web.config](../../AppServer/Web.config).

>В случае использования провайдера Oracle ODP.Net на серверной стороне при условии использования пользовательских типов данных SQL (UDT) необходимо иметь в виду следующее ограничение: ODP.Net для работы с UDT требует предварительно описанных оберточных классов (wrappers), и если в 2-звенной архитектуре адаптер XData создает их автоматически, то в 3-звенной архитектуре это сделать обычно не получится по причинам ограниченных прав сервиса. Рекомендуется запустить приложение в 2-звенном варианте. Провести действия которые затрагивают работу со всеми используемыми пользовательскими SQL типами (UDT) и подложить автоматически сформированные сборки-обертки в каталог bin сервиса. К сожалению способ работы Oracle ODP.Net с этими оберточными классами (wrappers) не позволяет нам пока решить проблемму более элегантными способами.

<!-- -->
>*Маленькая заметка:* По умолчанию WAS не настроен на активацию через net.tcp и это нужно включать отдельно, но информации по тому как включить в интерненте много, [например здесь](http://www.codeproject.com/Articles/717327/WCF-NetTcp-Binding).

##### Установка и настройка клиентской части
Клиентская часть при 3-звенном развертывании системы кроме основной библиотеки [XDataObject.dll](../../bin/) неявно использует специальный промежуточный модуль [XDataObject.Remote.dll](../../bin/) который должен находиться в одной папке с *XDataObject.dll*. В той же папке должны быть [клиентские и общие модули](./three_tier.md) Вашего приложения. Также потрубуются выбранные Вами модули логирования, библиотеки поддержки диалектов SQL **НО** не будут нужны как адаптеры ADO.Net провайдеров так и сами ADO.Net провайдеры используемые для контекстов настроенных в 3-звенной архитектуре. 

Кроме того в конфигурации Вашего приложении должен быть правильно описан WCF клиент в соответствии с настройками серверной части и в секции *xdata* нужно описать элементы *proxy* (см. выше) для всех [контекстов](.glossary.md#Контекст) которые используют 3-звенную архитектуру. При этом должно соблюдаться правило именования контекстов: на серверной и клиентской стороне они должны именоваться одинаково. Пример клиенсткой конфигурации можно посмотреть в [тестовом приложении](../../XDataTest/app.config).

>*Обратите внимание:* существует возможность комбинировать локальные источники данных и доступные в рамках 3-звенной архитектуры. При этом возможно как использование нескольких выделенных серверов приложений, так и использование нескольких контекстов данных за 1 сервером приложений XData.

<!-- -->
>*Если вдруг остались какието сомнения:* Да, это действительно все и не нужно писать отдельного сервера или серверных модулей, нужно просто поддерживать [простую и естественную организацию модулей](./three_tier.md) внутри Вашего проекта.
