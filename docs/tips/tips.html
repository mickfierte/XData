<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Tips &amp; Trics | XData website </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Tips &amp; Trics | XData website ">
    <meta name="generator" content="docfx 2.40.4.0">
    
    <link rel="shortcut icon" href=".././images/cube.ico">
    <link rel="stylesheet" href="../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../styles/docfx.css">
    <link rel="stylesheet" href="../styles/main.css">
    <meta property="docfx:navrel" content="../toc.html">
    <meta property="docfx:tocrel" content="toc.html">
    
    <meta property="docfx:rel" content="../">
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../index.html">
                <img id="logo" class="svg" src=".././images/cube-white.png" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div class="container body-content">
        
        <div id="search-results">
          <div class="search-list"></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="tips.md">
<h1 id="tips--trics">Tips &amp; Trics</h1>

<p>There are some special themes related with using XData in uncommon scenarios, or more detetailed information about not trivial internal XData mechanics.</p>
<h3 id="yaml-configuration-file">YAML configuration file</h3>
<p><em>(for .Net Standard 2.0 only!)</em></p>
<p>Since .Net Core and .Net Standard 2.0 supported various configuration file formats it&#39;s possible to configure XData with, as a sample, YAML file.</p>
<pre><code class="lang-yaml">connectionStrings:
    add:
        - name: &quot;DICT&quot;
          connectionString: &quot;Server=server;Database=test;User Id=postgres;Password=123456;Search Path=dictionaries&quot;
        - name: &quot;CONTACTS&quot;
          connectionString: &quot;Server=server;Database=test;User Id=postgres;Password=123456;Search Path=contacts&quot;
xdata: 
    adapter:
        - name: &quot;DICT_POSTGRESQL&quot;
          assembly: &quot;XData.PostgreSql.NpgSql.Adapter&quot;
          schema:
            dictionaries:
        - name: &quot;CONTACTS_POSTGRESQL&quot;
          assembly: &quot;XData.PostgreSql.NpgSql.Adapter&quot;
          schema:
            contacts:
    dialect:
        - name: &quot;POSTGRESQL&quot;
          assembly: &quot;XData.PostgreSql.Dialect&quot;
    context:
        - name: &quot;DICT&quot;
          adapter: &quot;DICT_POSTGRESQL&quot;
          dialect: &quot;POSTGRESQL&quot;
        - name: &quot;CONTACTS&quot;
          adapter: &quot;CONTACTS_POSTGRESQL&quot;
          dialect: &quot;POSTGRESQL&quot;
    default: &quot;CONTACTS&quot;
    debug: true
</code></pre><div class="TIP"><h5>Tip</h5><p>Note, the PostgreSQL connection strings can specify schema name in a <em>Search Path</em> key! That is required to work with tables from different then <em>public</em> schema without specify schema name in table name definitions.</p>
</div>
<div class="TIP"><h5>Tip</h5><p>Names of adapters, that use various connection strings must to be unique! Names of contexts must correspond connection strings names.</p>
</div>
<div class="TIP"><h5>Tip</h5><p>Be aware with PostgreSQL specific adapter configuration section <em>schema</em> required to specify home shema name for an adapter. Adapter and dialect specific configuration sections has described <a href="adapter_config.html">here</a>.</p>
</div>
<h3 id="adapter-and-dialect-specific-configuration">Adapter and dialect specific configuration</h3>
<p>Some of adapters and dialects has their own specific configuration settings to setup unique features and behaviors. That specific settings can be defined in configuration file or dynamically with <a class="xref" href="../api/XData.IDataOptions.html#XData_IDataOptions_AddAdapter_System_String_System_String_Microsoft_Extensions_Configuration_IConfiguration_">AddAdapter</a> or <a class="xref" href="../api/XData.IDataOptions.html#XData_IDataOptions_AddDialect_System_String_System_String_Microsoft_Extensions_Configuration_IConfiguration_">AddDialect</a> methods <em>options</em> parameter.</p>
<div class="TIP"><h5>Tip</h5><p>Function signatures is slightly different for .Net 4.0 version.</p>
</div>
<h4 id="xdatapostgresqlnpgsqladapter">XData.PostgreSql.NpgSql.Adapter:</h4>
<p>... when XML configuration file is used:</p>
<pre><code class="lang-xml">&lt;adapter name=&quot;POSTGRESQL_NPG&quot; assembly=&quot;XData.PostgreSql.NpgSql.Adapter&quot;&gt;
  &lt;schema name=&quot;public&quot;/&gt;
&lt;/adapter
</code></pre><p>... when YAML configuration file is used:</p>
<pre><code class="lang-yaml">adapter:
    - name: &quot;DICT_POSTGRESQL&quot;
      assembly: &quot;XData.PostgreSql.NpgSql.Adapter&quot;
      schema:
        dictionaries:
</code></pre><p>... when configuration is provided in runtime:</p>
<pre><code class="lang-csharp">// replace someschemaname to real schema name
var source = new MemoryConfigurationSource { InitialData = new[] {
    new KeyValuePair&lt;string, string&gt;(&quot;schema:someschemaname&quot;, null) }};
var conf = new ConfigurationBuilder().Add(source).Build();
...
.AddAdapter(&quot;postgresql&quot;, XData.PostgreSql.Adapter, conf)
</code></pre><h3 id="using-di-container">Using DI container</h3>
<p>XData can be effecively used with any DI containers You prefer. </p>
<p>Net 4.0 version not used DI containers inside, but <a class="xref" href="../api/XData.IDataEngine.html">IDataEngine</a>, <a class="xref" href="../api/XData.IDataScope.html">IDataScope</a> and <a class="xref" href="../api/XData.IRepository.html">IRepository&lt;T&gt;</a> interfaces can be obtained from container. IDataEngine must to be registered as singleton with <em>XDataManager.InitXData</em> method call. IDataScope can be registered as lifetime service over data logic module (for example: Controller module in MVC pattern) using fabric method with obtaining IDataEngine service and creating (<a class="xref" href="../api/XData.IDataEngine.html#XData_IDataEngine_NewDataScope_System_String_XData_Interfaces_ISecuritySession_">IDataEngine.NewDataScope</a>) or request from internal XData cache (<a class="xref" href="../api/XData.IDataEngine.html#XData_IDataEngine_GetDataScope_System_Guid_System_String_XData_Interfaces_ISecuritySession_System_Boolean_">IDataEngine.GetDataScope</a>) IDataScope instance when Layer is provided. IRepository&lt;T&gt; can be registered as transistent service using fabric method with obtaining IDataScope service and call <a class="xref" href="../api/XData.IDataScope.html#XData_IDataScope_GetRepository__1_XData_Variable___">IDataScope.GetRepository&lt;T&gt;</a> method. Using container to obtain IRepository&lt;T&gt; service seems to be a kind of a joke, but sometimes it&#39;s usefull.</p>
<p>Net Standard 2.0 version used Net Core Dependency Abstraction inside and this asbtraction can be implemented by any You like DI container. In this version <a class="xref" href="../api/XData.IDataEngine.html">IDataEngine</a> is registered by calling <a class="xref" href="../api/XData.XDataManager.html#XData_XDataManager_AddXData_Microsoft_Extensions_DependencyInjection_IServiceCollection_System_Func_XData_IDataOptions_XData_IDataOptions__">AddXData</a> method. Other interfaces can be registered manually (if required) with described above or any You like logic.</p>
<h3 id="large-object-loading">Large object loading</h3>
<p>Large objects specific properties <a class="xref" href="../api/XData.Mapping.Lob.html">Lob</a> and <a class="xref" href="../api/XData.Mapping.Xml.html">Xml</a> specialy used to lazy access to potetialy big sized data stored in database.</p>
<p>When <a href="../tutorial/glossary.html#data-object">data object</a> accessed using XData, large objects data not queried, but replaced with null values to create full structure of object. </p>
<p>To get or set value of <em>Lob</em> or <em>Xml</em> <a class="xref" href="../api/XData.Mapping.Lob.html#XData_Mapping_Lob_Value">Lob.Value</a> and <a class="xref" href="../api/XData.Mapping.Xml.html#XData_Mapping_Xml_Document">Xml.Document</a> properties are used. Size of <em>Lob</em> can be checked using <a class="xref" href="../api/XData.Mapping.Lob.html#XData_Mapping_Lob_GetSize">GetSize</a> method.</p>
<p>To simplify value assigning overrided operation <a class="xref" href="../api/XData.Mapping.Lob.html#XData_Mapping_Lob_op_Addition_XData_Mapping_Lob_System_Byte___">+=</a> can be used as described in example below:</p>
<pre><code class="lang-csharp">obj.Source += new XDocument(new XElement(&quot;invoice&quot;, new XAttribute(&quot;number&quot;, number), new XAttribute(&quot;state&quot;, z.DocStateCode)));
obj.Scan += Encoding.UTF8.GetBytes(z.Source.Document.ToString());
</code></pre><p>To modify value of large objects in <em>LINQ styled sequence of command</em> helper methods <a href="">Modify(Xml, Action&lt;XDocument&gt;)</a> and <a href="">Modify(Lob, Action&lt;Byte[]&gt;)</a> can be used like in example below:</p>
<pre><code class="lang-csharp">invoice.Modify(
        z =&gt; z.DocState += dataScope.GetDictionaryValue&lt;DocState&gt;(x =&gt; x.Code == newStateCode),
        z =&gt; z.Source.Modify(doc =&gt; doc.Element(&quot;invoice&quot;).Attribute(&quot;state&quot;).Value = newStateCode))
    .Submit();
</code></pre><div class="WARNING"><h5>Warning</h5><p>When object is <a href="json.html">serialized</a> large objects properties are serialized with null values by default! When actual value of large object is required it must to be requested separatly. To fill object large properties before serialization can be used one of <a class="xref" href="../api/XData.DataObjectExtensions.html#XData_DataObjectExtensions_LoadLob__1___0_System_Linq_Expressions_Expression_System_Func___0_System_Object_____">LoadLob</a> or <a href="">LoadLobAsync</a> helper method overloads.</p>
</div>
<h3 id="json-serialization">JSON serialization</h3>
<p>When used <a href="https://www.newtonsoft.com/json">Json.NET</a> XData <a href="">data objects</a> are serialized and deserialized automaticaly. </p>
<p>There are some serialization specifics of data objects:</p>
<ul>
<li>By default <a href="../tutorial/mapping/mapping.html#readonly-properties">Readonly properties</a> and <a href="../tutorial/mapping/mapping.html#hidden-properties">Hidden properties</a> are serialized and deserialized as well as writable properties, but have a some restrictions when copyed to object to apply into database (see <em>Apply</em> method description below).</li>
<li><a href="lob.html">Large objects</a>) are serialized to null value by default. They are designed for lazy data loading. To serialize data with actual values one of <a class="xref" href="../api/XData.DataObjectExtensions.html#XData_DataObjectExtensions_LoadLob__1___0_System_Linq_Expressions_Expression_System_Func___0_System_Object_____">LoadLob</a> helper method overloads can be used.</li>
<li>By default <a href="../tutorial/mapping/mapping.html#link-properties">Links</a> are serialized as limited representation of <a class="xref" href="../api/XData.Mapping.Link-2.html#XData_Mapping_Link_2_Source">link source</a> object. Only properties listed as <a href="../tutorial/mapping/dynamic/dynamic.html#links">LinkProperties</a> are included in serialized object. Additinaly an <em>&quot;linkPropertyName.Value&quot;</em> JSON property is serialized with the value of <a class="xref" href="../api/XData.Mapping.Link-2.html#XData_Mapping_Link_2_Value">Link.Value</a> property.</li>
</ul>
<p>Default serialization rules can be overrided with <em>ICollection&lt;T&gt;</em> and <em>T</em> <a class="xref" href="../api/XData.DataObjectExtensions.html#XData_DataObjectExtensions_WithJsonSettings__1___0_System_Func_XData_Json_JsonSettings___0__XData_Json_JsonSettings___0___">WithJsonSettings</a> extension methods.</p>
<p><a class="xref" href="../api/XData.Json.JsonSettings-1.html">JsonSettings&lt;T&gt;</a> has followed methods to specify serializing options:</p>
<ul>
<li><a class="xref" href="../api/XData.Json.JsonSettings-1.html#XData_Json_JsonSettings_1_Hide">Hide</a> - alow to specify properties to skip on serialization</li>
<li><a class="xref" href="../api/XData.Json.JsonSettings-1.html#XData_Json_JsonSettings_1_LoadLob">LoadLob</a> - alow to specify large object properties to load data before serialize (<em>LoadLob</em> method alternative)</li>
<li><a class="xref" href="../api/XData.Json.JsonSettings-1.html#XData_Json_JsonSettings_1_LinkMode_XData_Json_LinkMode_">LinkMode</a> - alow to specify serialization rules for multiple (or all) link properties:<ul>
<li>Default - default rules will be applied (see above)</li>
<li>Value - only value will be serialized</li>
<li>Source - only source will be serialized</li>
</ul>
</li>
</ul>
<pre><code class="lang-csharp">return dataScope.GetRepository&lt;Some&gt;().ToArray()
.WithJsonSettings(s =&gt; s.Hide(JsonHideFlags.Columns) //hide all columns
    .Hide(x =&gt; x.SomeReadOnlyProperty) //hide SomeReadOnlyProperty
    .LoadLob() //load all large data properties
    .LinkMode(LinkMode.Deafult, 
        x =&gt; SomeLinkProperty, x =&gt; AnotherLinkProperty) //set default rules to 2 properties
    .LinkMode(LinkMode.Value)); //set other link properties serialize Value property only
</code></pre><div class="WARNING"><h5>Warning</h5><p>Deserialized objects are detached from repository and had limited ways of using!</p>
</div>
<ul>
<li>Deserialized object can be used as a filter to find data object in database (for example to delete) with <a class="xref" href="../api/XData.DataObjectExtensions.html#XData_DataObjectExtensions_Find__1_XData_IRepository___0____0_System_Boolean_">Find</a> method:</li>
</ul>
<pre><code class="lang-csharp">var found = dataScope.GetRepository&lt;Some&gt;().Find(detachedObj);
if(found == null) throw DbConcurrencyException();
return found.SetDeleted(true).Submit();
</code></pre><ul>
<li>Deserialized object can be used as a source to copy some data to new object with <a class="xref" href="../api/XData.DataObjectExtensions.html#XData_DataObjectExtensions_Copy__1___0___0_XData_CopyFlag_System_String___">Copy</a> method:</li>
</ul>
<pre><code class="lang-csharp">return dataScope.GetRepository&lt;Some&gt;().New().Copy(detachedObj).Submit();
</code></pre><ul>
<li>Deserialized object can be used as to apply changes to database with <a class="xref" href="../api/XData.DataObjectExtensions.html#XData_DataObjectExtensions_Apply__1_XData_IRepository___0____0_XData_ApplyFlag_System_String___">Apply</a> method:</li>
</ul>
<pre><code class="lang-csharp">dataScope.GetRepository&lt;Some&gt;().Apply(detachedObj).Submit();
</code></pre><p><em>Apply</em> is a combination of <em>Find</em> and <em>Copy</em> methods with followed algorithm:</p>
<p>1) if <em>detached object</em> has all keys assigned, corresponded object will be searched in database using keys and correlation token (if described in mapping) values (*)</p>
<p>2) if no data found XDataConcurrencyException will be throwed (**)</p>
<p>3) when some key properties are not assigned new entity has been created </p>
<p>4) <em>detached object&#39;s</em> data will be copyed to found (or new) object (***)</p>
<p>(*) Using of correlation token value with <em>Find</em> method can be escaped with optional <em>ignoreConcurrency</em> parameter. Same result can be reached with <a class="xref" href="../api/XData.ApplyFlag.html">ApplyFlag.IgnoreConcurrency</a> flag has been passed in <em>Apply</em> method call.</p>
<p>(**) <a class="xref" href="../api/XData.ApplyFlag.html">ApplyFlag.AddWhenNotFound</a> flag can be passed in <em>Apply</em> method call to add new entity when not found in database.</p>
<p>(***) <em>Copy</em> and <em>Apply</em> has parameter <em>properties</em> to specify wich property values will be copied. <a class="xref" href="../api/XData.ApplyFlag.html">ApplyFlag.ExceptProperties</a> or <a class="xref" href="../api/XData.CopyFlag.html">CopyFlag.ExceptProperties</a> flag can be used to SKIP listed <em>properties</em> on copy. <a class="xref" href="../api/XData.ApplyFlag.html">ApplyFlag.CopyReadOnlyProperties</a> or <a class="xref" href="../api/XData.CopyFlag.html">CopyFlag.CopyReadOnlyProperties</a> flag can be used to allow copy <a href="../tutorial/mapping/mapping.html#readonly-properties">Readonly properties</a> and <a href="../tutorial/mapping/mapping.html#hidden-properties">Hidden properties</a> disabled by default.</p>
<h3 id="asynchronious-wrapped-operations">Asynchronious wrapped operations</h3>
<p>To access data with XData inside async methods it&#39;s handy to use asynchronous wrappers declared inside <a class="xref" href="../api/XData.Async.AsyncExtensions.html">XData.Async etxtension methods</a> as illustrated in followed example:</p>
<pre><code class="lang-csharp">internal async Task&lt;DocType[]&gt; TestArrayAsync(IDataEngine dataEngine)
{
    using (var dataScope = dataEngine.NewDataScope(&quot;TEST_POSTGRE_NPG&quot;))
    {
        return await dataScope.GetRepository&lt;DocType&gt;().ToArrayAsync();
    }
}
</code></pre><h3 id="mapping-view">Mapping view</h3>
<p>To map <a href="../tutorial/glossary.html#data-object">data objects</a> to SQL views used same technics and commands as data table, but then mapping non readonly <a href="../tutorial/glossary.html#repository">repository</a> to table some fields of <a href="../tutorial/glossary.html#updatable-tables-hierarchy">updatable table</a> can be mapped automatically by XData engine using metadata information from source database. When mapping is described over view, all fields must to be described explicitly. Same rule is worked when source of data is text represented SQL expression or virtual recordset defined as union of records (see <a class="xref" href="../api/XData.Mapping.Dynamic.QueryDescriptionExtensions.html#XData_Mapping_Dynamic_QueryDescriptionExtensions_ToDataSet__1_System_Collections_Generic_IEnumerable___0__System_String_XData_Interfaces_ISqlBuilder_">ToDataSet</a> as example, similar result can be reached using string SQL expression as table name). All fields must to be described explicitly.</p>
<div class="IMPORTANT"><h5>Important</h5><p>Repositiory mapping is required to marked as <a href="../tutorial/glossary.html#data-source-flags">ReadOnly</a> when view is a base table!</p>
</div>
<h3 id="get-connection-settings-in-runtime">Get connection settings in runtime</h3>
<p>Connection settings can be obtained from initialized context using code below:</p>
<pre><code class="lang-csharp">var ctx = dataScope.GetContext(s);
Console.WriteLine(&quot;*** Testing context: {0} (DB type: {1})&quot;, ctx.Name, ctx.DatabaseAdapter.ConnectType);
Console.WriteLine(&quot;*** Server: {0}, Schema: {1}&quot;, ctx.ConnectionInfo.Server, ctx.ConnectionInfo.Schema);
</code></pre><h3 id="optional-filters">Optional filters</h3>
<p>Optional filters is the mechanic to simplify query structure when some filters are not set. For example, we can map data structure to some class and to alow filter objects over some property of dictionary linked to main data structure. When filter applied this link to dictionary table is used, but when not we ineffectively rize query complexity.</p>
<p>To avoid unplanned query complexity XData has <em>optional filter</em> feature. Some filters marked as <em>primary</em> - when this filter has value, query has full form. When filter value has cleared or set to null, data source of filtered field (table or view) will be skiped when SQL query composed. When data source has been skipped then links between already skipped and other data sources are analized. And when found link marked as <em>primary</em> linked data source will also skipped. When <a href="../tutorial/glossary.html#base-table">base table</a> of subquery has been skipped - all subquery will be skipped and subquery links analizis for <em>primary</em> links will be provided over outer query. Until no <em>primary</em> filters found.</p>
<p>This alowes to compose complex query relations over multiple tables and subqueries that reflect on real query only when it realy necessary.</p>
<h3 id="conditional-filters">Conditional filters</h3>
<p>XData realization of LINQ &quot;Where&quot; method has provide ability to use runtime condition evaluation during predicate compilation into SQL statements to analyze runtime data and conditionaly omit non valued data (0, empty or null) filters.</p>
<pre><code class="lang-csharp">// string author, int rating, decimal? lowerPrice and decimal? higherPrice is an optional filter values
return dataScope.GetRepository&lt;Book&gt;()
    .Where(x =&gt; (string.IsNullOrEmpty(author) || x.Author == author)
    &amp;&amp; (rating &lt;= 0 || x.Rating &gt;= rating)
    &amp;&amp; (lowerPrice.HasValue || x.Price &gt;= lowerPrice)
    &amp;&amp; (higherPrice.HasValue || x.Price &lt;= higherPrice))
.ToArray();
</code></pre><p>When runtime condition is true and LINQ expression is OrElse whole expression is omitted while predicate compilation into SQL statements.</p>
<h3 id="outer-joined-table-filtration-specifics">Outer joined table filtration specifics</h3>
<pre><code class="lang-csharp">XDataMapping.CustomMapping&lt;UserList&gt;()
    .DataTable(&quot;t_user&quot;, &quot;U&quot;)
    // *t_user_claim* has inner joined to *t_user* by *user_id* field
    .DataTable(&quot;t_user_claim&quot;, &quot;UC&quot;, z =&gt; z.Link(&quot;U&quot;, &quot;user_id&quot;),
        // constant filter use defaut equal operation (see SQL result below)
        z =&gt; z.ConstFilter(&quot;ClaimNickName&quot;, &quot;claim_type&quot;, &quot;nickname&quot;))
    // *t_user_app* has outer joined to *t_user* by *user_id* field
    .DataTable(&quot;t_user_app&quot;, &quot;A&quot;,
        x =&gt; x.Link(&quot;U&quot;, &quot;user_id&quot;).SetOperation(FilterOperation.OuterJoin),
        // IMOPRTANT! all filters for outer joined table must use *OuterJoin* operation to apply correct filtration
        x =&gt; x.ConstFilter(&quot;FilterByAsubs&quot;, &quot;app_type&quot;, (int) AppType.Asubs).SetOperation(FilterOperation.OuterJoin),
        x =&gt; x.ConstFilter(&quot;FilterByAsubsEnabled&quot;, &quot;enabled&quot;, 1).SetOperation(FilterOperation.OuterJoin))
</code></pre><pre><code class="lang-sql">select ... from t_user U
join t_user_claim UC on UC.user_id = U.user_id
outer join t_user_app A on A.user_id = U.user_id and A.app_type = 1 and A.enabled = 1
</code></pre><p>Constant filters are moved to outer join condition not in where statement conditions and query will return correct results.</p>
<p>Similar rules is applied to static mapping and dynamic query.</p>
<h3 id="tree-organized-repository-child-specifics">Tree organized repository child specifics</h3>
<p>When master repository has hierarchy structure, than slave objects can be filtered by two methods to choose slave repository data: filter data linked with selected tree node only (<a class="xref" href="../api/XData.Mapping.ExternalLinkAttribute.html#XData_Mapping_ExternalLinkAttribute_DirectLink">direct links</a>), and linked to subtree from selected node and below by hierarchy. XData has functional to choose one of this methods in runtime. To provide this ability mapping of master objects must describe <a href="../tutorial/mapping/mapping.html#master-slave-relations">external links</a> marked as <a class="xref" href="../api/XData.Mapping.ExternalLinkAttribute.html#XData_Mapping_ExternalLinkAttribute_DirectLink">direct links</a>. Than master repository flag <a class="xref" href="../api/XData.IRepository.html#XData_IRepository_ShowSubtree">ShowSubtree</a> can be used as a switch between this two methods.</p>
<h3 id="reuse-mapping-in-dynamic-query">Reuse mapping in dynamic query</h3>
<p>Already declared mappings can be reused in <a href="../tutorial/query.html">dynamic query</a> construction with generic <a class="xref" href="../api/XData.Mapping.Dynamic.XDataMapping.html#XData_Mapping_Dynamic_XDataMapping_GetStructure__1_System_String_">GetStructure</a> method overload.</p>
<p>See the example below to understand how it works:</p>
<pre><code class="lang-csharp">using (var dataScope = DataEngine.NewDataScope())
{
    var user = dataScope.GetRepository&lt;User&gt;().SingleOrDefault(x =&gt; x.UserId.ToString() == userId);
    if (user == null)
        throw new Exception(&quot;User not found!&quot;);

    // prepare enum values expression array to *Case* expression based on AppType enum
    var enumValues = typeof(AppType).GetEnumKeyValuePairs()
        .Select(i =&gt; i.Key.SetExpression(x =&gt; i.Value))
        .ToArray();

    // reuse *UserRole* mapping adding filter by *user_id* column and redefine select output
    var roleClaims = XDataMapping.GetStructure&lt;UserRole&gt;().AddFilters(&quot;UR&quot;,
        x =&gt; x.ConstFilter(&quot;FilterByUserId&quot;, &quot;user_id&quot;, userId.ToString()))
        .Column(&quot;UserId&quot;, x =&gt; x.Field&lt;Guid&gt;(&quot;UR&quot;, string.Empty))
        .Select(x =&gt; new UserClaim
        {
            // set negative id to preserve key uniqueness after appling *Union* operation using expression field
            Id = x.Expr(&quot;id&quot;, z =&gt; -1 * z.Field&lt;long&gt;(&quot;R&quot;, &quot;role_id&quot;), DbType.Int64),
            Type = x.Expr(&quot;role&quot;, z =&gt; &quot;role&quot;, DbType.String),
            // construct role name based by *app_type* enum field and role name using SQL *Case* expression
            Value = x.Expr(&quot;val&quot;, z =&gt; z.Case(y =&gt; y.Field&lt;long&gt;(&quot;R&quot;, &quot;app_type&quot;), y =&gt; &quot;&quot;, enumValues) 
                + &quot;.&quot; + x.Field&lt;string&gt;(&quot;R&quot;, &quot;role&quot;), DbType.String)
        }).AsQuery(dataScope.Layer);

    user.Applications = apps.SetFilterValue(x =&gt; UserId, userId).ToArray();
    user.Roles = dataScope.GetRepository&lt;UserRole&gt;().SetFilterValue(x =&gt; UserId, userId).ToArray();
    // Combine simple claims and synthetic role claims
    user.Claims = dataScope.GetRepository&lt;UserClaim&gt;()
        .SetFilterValue(x =&gt; UserId, userId)
        .Union(roleClaims).ToArray();

    return user;
}
</code></pre><h3 id="dynamic-query-external-data-sources">Dynamic query external data sources</h3>
<p>XData <a href="../tutorial/query.html">dynamic query</a> can use external data sources to operate with runtime tabular or xml data together with data stored inside database.</p>
<div class="WARNING"><h5>Warning</h5><p>This feature is not supported by all of databases! XML data sources can be used with Ms SQL Server and PostgreSQL only. Local temporary tables is not supported by Oracle database.
As You can see, Oracle not supported both of features. Use PL/SQL functions, packages or predefined global temporary tables instead.</p>
</div>
<h3 id="xml-data-source">XML data source</h3>
<pre><code class="lang-csharp">// prepare XML document
var doc = new XDocument(new XElement(&quot;root&quot;, 
    new XElement(&quot;test&quot;, new XAttribute(&quot;doc_state_id&quot;, 1), new XAttribute(&quot;test&quot;, &quot;one&quot;)),
    new XElement(&quot;test&quot;, new XAttribute(&quot;doc_state_id&quot;, 2), new XAttribute(&quot;test&quot;, &quot;two&quot;))
    )).ToString();
var query = XDataMapping.GetStructure(&quot;S&quot;, dataScope.DefaultContext)
    .DataTable(&quot;T_DOC_STATE&quot;, &quot;S&quot;)
    // use XmlSource definition providing XPath expression for data source
    .XmlSource(&quot;Test&quot;, &quot;T&quot;, &quot;root/test&quot;, x =&gt; x.Link(&quot;S&quot;, &quot;doc_state_id&quot;))
    .Select(x =&gt; new {
        // use XmlField definition with XPath expression as a field source
        DocStateId = x.XmlField&lt;int&gt;(&quot;T&quot;, string.Empty, &quot;@doc_state_id&quot;, DbType.Int32, z =&gt; z.Key()),
        Code = x.Field&lt;string&gt;(&quot;S&quot;, string.Empty),
        // note, string and number (decimal) xml fields need size defined, like an expression fields
        Test = x.XmlField&lt;string&gt;(&quot;T&quot;, string.Empty, &quot;@test&quot;, DbType.String, z =&gt; z.Size(20))
    // set XML string to variable with the same name as XmlSource
    }).AsQuery(dataScope.Layer, &quot;Test&quot;.SetVar(doc));
</code></pre><h3 id="temporary-table">Temporary table</h3>
<pre><code class="lang-csharp">// prepare tabular data
var table = new DataTable();
table.Columns.AddRange(new [] { new DataColumn(&quot;doc_state_id&quot;, typeof(long)),
    new DataColumn(&quot;test&quot;, typeof(string)) });
table.Rows.Add(1, &quot;one&quot;);
table.Rows.Add(2, &quot;two&quot;);
table.AcceptChanges();

var query = XDataMapping.GetStructure(&quot;S&quot;, dataScope.DefaultContext)
    .DataTable(&quot;T_DOC_STATE&quot;, &quot;S&quot;)
    // use temporary table definition
    .TempTable(&quot;Test&quot;, &quot;T&quot;, x =&gt; x.Link(&quot;S&quot;, &quot;doc_state_id&quot;))
    .Select(x =&gt; new {
        // use Field method overload with dbType parameter to define temporary table field
        DocStateId = x.Field&lt;long&gt;(&quot;T&quot;, string.Empty, DbType.Int64, z =&gt; z.Key()),
        Code = x.Field&lt;string&gt;(&quot;S&quot;, string.Empty),
        // note, string and number (decimal) xml fields need size defined, like an expression fields
        Test = x.Field&lt;string&gt;(&quot;T&quot;, string.Empty, DbType.String, z =&gt; z.Size(20))
    // set DataTable to variable with the same name as TempTable
    }).AsQuery(dataScope.Layer, &quot;Test&quot;.SetVar(table));
</code></pre><h3 id="using-dictionaries">Using dictionaries</h3>
<p>Dictionaries can be used to reduse data requery count when rarely changed data of dictionary will linked multiple times through <a class="xref" href="../api/XData.Mapping.Link-2.html">Link&lt;T,TSource&gt;</a> data type properties over small amount of time (one business process). Dictionaries is cached as single mapped objects (not a data cahe as described in <a href="fixed.html">Caching repository data</a> topic).</p>
<h3 id="property-update-source">Property update source</h3>
<p><a href="../tutorial/glossary.html#data-object">Data object</a> properties (or <a href="../tutorial/mapping/column.html">hidden properties</a>) values can depend on other properties values or calculated with some expression. XData allow to describe this expression or dependency as part of mapping, to skip that property initialization when inserting or updating data object. Property value update source is used when data object is inserted or updated. When property <a href="../tutorial/mapping/static/static.html#property-default-value">default value</a> and update source are defined, default value is used on insert and update source on update.</p>
<p>Property value update source expression when using static mapping is defined by <a class="xref" href="../api/XData.Mapping.PropertyUpdateWithAttribute.html">PropertyUpdateWithAttribute</a> (or <a class="xref" href="../api/XData.Mapping.ColumnUpdateWithAttribute.html">ColumnUpdateWithAttribute</a>) with same rules as PlainSQL or LinqExpression <a href="../tutorial/mapping/static/static.html#sql-expression-property">SQL expression properties</a>:</p>
<pre><code class="lang-csharp">// for PlainSQL
[PropertyUpdateWith(&quot;case P.is_vip when 1 then 10 else 0 end&quot;)]
// or for LinqExpression
[PropertyUpdateWith(&quot;AllowedDiscount&quot;, DataExpressionType.LinqExpression)]
...
[SqlExpression]
private static Calculate&lt;int&gt; AllowedDiscount = x =&gt; x.Case&lt;Product, int&gt;( 
    z =&gt; z.Field&lt;bool&gt;(&quot;is_vip&quot;), z =&gt; 0, 1.SetExpression(z =&gt; 10));
</code></pre><p>When using dynamic mapping it is defined by <a class="xref" href="../api/XData.Mapping.Dynamic.IRepositoryStructureAdapter-1.html#XData_Mapping_Dynamic_IRepositoryStructureAdapter_1_Field__1_System_Linq_Expressions_Expression_System_Func_XData_Mapping_Dynamic_IRepositoryPropertyMappingAdapter__0___0__XData_Mapping_Dynamic_IStructureFlag_____">Field&#39;s</a> mapping attribute <a class="xref" href="../api/XData.Mapping.Dynamic.IRepositoryPropertyMappingAdapter-2.html#XData_Mapping_Dynamic_IRepositoryPropertyMappingAdapter_2_UpdateWith_System_Linq_Expressions_Expression_System_Func_XData_Mapping_Dynamic_IQueryStructureAdapter__1___">UpdateWith</a> overloads:</p>
<ul>
<li><a class="xref" href="../api/XData.Mapping.Dynamic.IRepositoryPropertyMappingAdapter-2.html#XData_Mapping_Dynamic_IRepositoryPropertyMappingAdapter_2_UpdateWith_XData_DataExpressionType_System_String_">UpdateWith(DataExpressionType type, string exprText)</a></li>
<li><a class="xref" href="../api/XData.Mapping.Dynamic.IRepositoryPropertyMappingAdapter-2.html#XData_Mapping_Dynamic_IRepositoryPropertyMappingAdapter_2_UpdateWith_System_Linq_Expressions_Expression_System_Func_XData_Mapping_Dynamic_IQueryStructureAdapter__1___">UpdateWith(Expression&lt;Func&lt;IQueryStructureAdapter, TValue&gt;&gt; expr)</a></li>
</ul>
<pre><code class="lang-csharp">DeliveryDate = x.Field&lt;DateTime?&gt;(&quot;DD&quot;, string.Empty, z =&gt; z.UpdateWith(y =&gt; DateTime.Today.AddDays(1)))
</code></pre><p>Property value update source dependancy when using static mapping is defined by <a class="xref" href="../api/XData.Mapping.PropertyUpdateWithAttribute.html">PropertyUpdateWithAttribute</a> (or <a class="xref" href="../api/XData.Mapping.ColumnUpdateWithAttribute.html">ColumnUpdateWithAttribute</a>) with same rules as Subquery <a href="../tutorial/mapping/static/static.html#sql-expression-property">SQL expression properties</a>:</p>
<pre><code class="lang-csharp">[Subquery(&quot;A&quot; /* subquery alias */, 
    typeof(DocSpecAmounts) /* subquery mapped type */, 
    &quot;Amount&quot; /* subquery result property name */, 
    Grouping = DataGrouping.Sum /* result property aggregation type */)]
...
[PropertyUpdateWith(&quot;A&quot;, DataExpressionType.SubQuery)]
</code></pre><p>When using dynamic mapping it is defined by <a class="xref" href="../api/XData.Mapping.Dynamic.IRepositoryStructureAdapter-1.html#XData_Mapping_Dynamic_IRepositoryStructureAdapter_1_Field__1_System_Linq_Expressions_Expression_System_Func_XData_Mapping_Dynamic_IRepositoryPropertyMappingAdapter__0___0__XData_Mapping_Dynamic_IStructureFlag_____">Field&#39;s</a> mapping attribute <a class="xref" href="../api/XData.Mapping.Dynamic.IRepositoryPropertyMappingAdapter-2.html#XData_Mapping_Dynamic_IRepositoryPropertyMappingAdapter_2_UpdateWith__1_System_String_XData_Mapping_Dynamic_IQueryDescription___0__System_Linq_Expressions_Expression_System_Func___0__1___XData_DataGrouping_System_Linq_Expressions_Expression_System_Func_XData_Mapping_Dynamic_ISubqueryLinkAdapter__0___0__XData_Mapping_Dynamic_IStructureFlag_____">UpdateWith</a> overloads:</p>
<ul>
<li><a class="xref" href="../api/XData.Mapping.Dynamic.IRepositoryPropertyMappingAdapter-2.html#XData_Mapping_Dynamic_IRepositoryPropertyMappingAdapter_2_UpdateWith_System_String_System_Type_System_String_XData_DataGrouping_System_Linq_Expressions_Expression_System_Func_XData_Mapping_Dynamic_ISubqueryLinkAdapter_XData_Mapping_Dynamic_IStructureFlag_____">UpdateWith(string alias, Type dobjType, string property, DataGrouping grouping = DataGrouping.None, params Expression&lt;Func&lt;ISubqueryLinkAdapter, IStructureFlag&gt;&gt;[] attributes)</a></li>
<li><a class="xref" href="../api/XData.Mapping.Dynamic.IRepositoryPropertyMappingAdapter-2.html#XData_Mapping_Dynamic_IRepositoryPropertyMappingAdapter_2_UpdateWith__1_System_String_XData_Mapping_Dynamic_IQueryDescription___0__System_String_XData_DataGrouping_System_Linq_Expressions_Expression_System_Func_XData_Mapping_Dynamic_ISubqueryLinkAdapter__0___0__XData_Mapping_Dynamic_IStructureFlag_____">UpdateWith(string alias, IQueryDescription&lt;TDObj&gt; sub, string property, DataGrouping grouping = DataGrouping.None, params Expression&lt;Func&lt;ISubqueryLinkAdapter, IStructureFlag&gt;&gt;[] attributes)</a></li>
<li><a class="xref" href="../api/XData.Mapping.Dynamic.IRepositoryPropertyMappingAdapter-2.html#XData_Mapping_Dynamic_IRepositoryPropertyMappingAdapter_2_UpdateWith__1_System_String_XData_Mapping_Dynamic_IQueryDescription___0__System_Linq_Expressions_Expression_System_Func___0__1___XData_DataGrouping_System_Linq_Expressions_Expression_System_Func_XData_Mapping_Dynamic_ISubqueryLinkAdapter__0___0__XData_Mapping_Dynamic_IStructureFlag_____">UpdateWith(string alias, IQueryDescription&lt;TDObj&gt; sub, Expression&lt;Func&lt;TDObj, TValue&gt;&gt; property, DataGrouping grouping = DataGrouping.None, params Expression&lt;Func&lt;ISubqueryLinkAdapter, IStructureFlag&gt;&gt;[] attributes)</a></li>
</ul>
<pre><code class="lang-csharp">DeliveryType = x.Field&lt;DeliveryTypeEnum&gt;(&quot;DD&quot;, string.Empty, z =&gt; z.UpdateWith(&quot;DT&quot;, 
    XDataMapping.GetStructure(&quot;&quot;, null, DataStructureFlag.None)
        .Select(y =&gt; new { DeliveryType = y.Expr(&quot;delivery_type&quot;, a =&gt; DeliveryTypeEnum.Courier, DbType.Int32)}), 
    y =&gt; y.DeliveryType, DataGrouping.None)),
</code></pre><h3 id="default-value-features">Default value features</h3>
<p><a href="../tutorial/glossary.html#data-object">Data object</a> properties (or <a href="../tutorial/mapping/column.html">hidden properties</a>) can be assigned by default values described by mapping. </p>
<p>Using <a class="xref" href="../api/XData.DefaultFeature.html">DefaultFeature</a> enumeration it&#39;s possible to extend basic functionality of default value assignment with...</p>
<ul>
<li><strong>UseOnUpdate</strong> - use default value not only on insert, but on update also.</li>
<li><strong>SkipWhenAssigned</strong> - skip insert into table when PK value assigned explicitly.</li>
<li><strong>UpdateWhenAssigned</strong> - change insert operation over table to update when PK value assigned explicitly.</li>
</ul>
<p>Last two of features is usable when data object &#39;s primary table is linked with another table in data object mapping as one-to-one, and insert into base table can be skipped (or replaced with update statement) when it&#39;s primary key is assigned explicitly in application code.</p>
<p>This features helps logicaly combine mappings to hide technological entities, which don&#39;t reflect buseness object model of application. </p>
<p>Default features can be combined. For example: </p>
<pre><code class="lang-csharp">DefaultFeature.UseOnUpdate | DefaultFeature.SkipWhenAssigned
</code></pre><h3 id="caching-repository-data">Caching repository data</h3>
<p>Some data is changed often, some is rarely, but some data will never changed untill application has upgraded. To reduse requery of this static data, XData has mechanism to cache requested data (not a mapped objects) in XData. Repository property <a class="xref" href="../api/XData.IRepository.html#XData_IRepository_FixedQuery">FixedQuery</a> can be assigned to true when caching is required. All LINQ queries will be translated to this cache without requery data from database. When this property resets to false, the cache will erased and repository returns to common algorithms of database requests. Similar feature is used to access rarely changed <a href="dictionary.html">dictionary</a> data over multiple related operative data canges.</p>
<h3 id="copy-data">Copy data</h3>
<p>Data can be copied from one repository to another using <a class="xref" href="../api/XData.IRepository-1.html#XData_IRepository_1_Add__1_System_Linq_IQueryable___0__XData_Mapping___0__0__">IRepository&lt;T&gt;.Add&lt;TFrom&gt;</a> method as illustrated in followed example:</p>
<pre><code class="lang-csharp">// Query source data (statically, or dynamically) into sourceQuery variable 
var rep = dataScope.GetRepository&lt;Target&gt;();
using(var tr = dataScope.BeginTransaction())
{
    rep.Add&lt;Source&gt;(sourceQuery, 
        x =&gt; new Target{ 
            TargetSome = x.Some, 
            TargetAnother = x.Another });
    tr.Commit();
}
</code></pre><h3 id="trigger-business-logic">Trigger business logic</h3>
<p><a href="custom_logic.html">Custom logic</a> called over <a href="../tutorial/glossary.html#data-object">data object</a> explicitly. But XData can call trigger logic over business valuable <a href="../tutorial/glossary.html#data-object">data object</a> (not a single table!) on middleware level (no matter extracted this logic to dedicated application server or not). This logic will be called automatically when corresponded changes are applied:</p>
<ul>
<li><em>InitRepository</em> - middleware trigger executed when Repository has been initialized (trigger delegate type -<a class="xref" href="../api/XData.InitRepository-1.html">InitRepository&lt;T&gt;</a>)</li>
<li><em>InvalidateRepository</em> - middleware trigger executed when Repository data need to be reseted (trigger delegate type -<a class="xref" href="../api/XData.InvalidateRepository-1.html">InvalidateRepository&lt;T&gt;</a>)</li>
<li><em>InvalidateObject</em> - middleware trigger executed when Repository object need to be reloaded (trigger delegate type -<a class="xref" href="../api/XData.InvalidateObject-1.html">InvalidateObject&lt;T&gt;</a>)</li>
<li><em>InitObject</em> - middleware trigger executed when Repository object has been initialized (trigger delegate type -<a class="xref" href="../api/XData.InitObject-1.html">InitObject&lt;T&gt;</a>)</li>
<li><em>BeforeInsert</em> - middleware trigger executed before object inserted into Repository (trigger delegate type -<a class="xref" href="../api/XData.Trigger-1.html">Trigger&lt;T&gt;</a>)</li>
<li><em>BeforeUpdate</em> - middleware trigger executed before Repository object has been updated (trigger delegate type -<a class="xref" href="../api/XData.Trigger-1.html">Trigger&lt;T&gt;</a>)</li>
<li><em>BeforeDelete</em> - middleware trigger executed before object has been deleted from Repository (trigger delegate type -<a class="xref" href="../api/XData.Trigger-1.html">Trigger&lt;T&gt;</a>)</li>
<li><em>AfterInsert</em> - middleware trigger executed after object inserted into Repository (trigger delegate type -<a class="xref" href="../api/XData.Trigger-1.html">Trigger&lt;T&gt;</a>). <a class="xref" href="../api/XData.DataTriggerFlag.html">Skip</a> flag is not applicable!</li>
<li><em>AfterUpdate</em> - middleware trigger executed after Repository object has been updated (trigger delegate type -<a class="xref" href="../api/XData.Trigger-1.html">Trigger&lt;T&gt;</a>). <a class="xref" href="../api/XData.DataTriggerFlag.html">Skip</a> flag is not applicable!</li>
<li><em>AfterDelete</em> - middleware trigger executed after object has been deleted from Repository (trigger delegate type -<a class="xref" href="../api/XData.Trigger-1.html">Trigger&lt;T&gt;</a>). <a class="xref" href="../api/XData.DataTriggerFlag.html">Skip</a> flag is not applicable!</li>
<li><em>BeforeClear</em> - middleware trigger executed before Repository has been cleared (trigger delegate type -<a class="xref" href="../api/XData.RepositoryTrigger-1.html">RepositoryTrigger&lt;T&gt;</a>)</li>
<li><em>AfterClear</em> - middleware trigger executed after Repository has been cleared (trigger delegate type -<a class="xref" href="../api/XData.RepositoryTrigger-1.html">RepositoryTrigger&lt;T&gt;</a>). <a class="xref" href="../api/XData.DataTriggerFlag.html">Skip</a> flag is not applicable!</li>
</ul>
<p>Trigger delegate type - it&#39;s a method signature for middleware trigger handler.</p>
<pre><code class="lang-csharp">public class InvoiceLogic : XDataLogic&lt;Invoice&gt;
{
    [Action(DataActionType.AfterInsert), Action(DataActionType.AfterUpdate)]
    public Trigger&lt;Invoice&gt; UpdateHistory =&gt; 
        ((ref Invoice invoice, ref DataTriggerFlag flag) =&gt;
        {
            if (!invoice.CheckState(DataObjectState.New) 
                &amp;&amp; !invoice.IsChanged(x =&gt; x.DocState)) return true;
            var rep = invoice.GetRepository();
            using (var hist = 
                GetRepository&lt;DocHistory&gt;(rep.Layer, context: rep.Context))
            {
                hist.Reset()
                    .SetFilterValue(DocHistory.FilterByDocId, 
                        invoice.GetProperty&lt;long&gt;(&quot;DocId&quot;))
                    .SetFilterValue(DocHistory.FilterByDocStateId, 
                        invoice.DocState.Key);
                var newHist = hist.New();
                newHist.HistoryDate = DateTime.UtcNow;
                return hist.Submit(ref newHist);
            }
        });

    [Action(DataActionType.BeforeDelete)]
    public Trigger&lt;Invoice&gt; ClearHistory =&gt; 
    ((ref Invoice invoice, ref DataTriggerFlag flag) =&gt;
        {
            var i = invoice;
            using (var hist = GetRepository&lt;DocHistory&gt;(i.GetLayer(), 
                context: i.GetContext()))
            {
                return hist.Reset()
                    .Clear(x =&gt; x.GetProperty&lt;long&gt;(&quot;DocId&quot;) 
                        == i.GetProperty&lt;long&gt;(&quot;DocId&quot;));
            }
        });

    [Action(DataActionType.BeforeClear)]
    public RepositoryTrigger&lt;Invoice&gt; ClearHistoryBatch =&gt;
    ((IRepository&lt;Invoice&gt; invoiceRepository, ref DataTriggerFlag flag) =&gt;
    {
        using (var hist = GetRepository&lt;DocHistory&gt;(invoiceRepository.Layer, 
            context: invoiceRepository.Context))
        {
            return hist.Reset().Clear(x =&gt; invoiceRepository
                .Any(z =&gt; x.GetProperty&lt;long&gt;(&quot;DocId&quot;) 
                    == z.GetProperty&lt;long&gt;(&quot;DocId&quot;)));
        }
    });
}
</code></pre><p>Trigger and RepositoryTrigger delegates has a reference parameter of type <a class="xref" href="../api/XData.DataTriggerFlag.html">DataTriggerFlag</a> to specify behaviour of data processing after trigger executed. There are three possible behaviours defined:</p>
<ul>
<li><em>None</em> - Submit using default algorithm, representation layer is already refreshed</li>
<li><em>Skip</em> - Data submitting have completed in trigger logic or not applicable. No standard updates will called. It&#39;s a kind of &quot;instead of&quot; trigger logic flag.</li>
<li><em>Refresh</em> - Default value. Representation layer manual data refreshing is needed.</li>
</ul>
<p>Trigger logic defined as attributed by <a class="xref" href="../api/XData.Mapping.ActionAttribute.html">Action attribute</a> read only property of <a class="xref" href="../api/XData.XDataLogic-1.html">XDataLogic&lt;T&gt;</a> class descendant. One property can be attributed as a handler for multiple triggers. Property type must to be <a class="xref" href="../api/XData.Trigger-1.html">Trigger&lt;T&gt;</a> except repository based triggers (<em>BeforeClear</em>, <em>AfterCLear</em>, <em>InitRepository</em> or <em>InvalidateRepository</em>) - <a class="xref" href="../api/XData.RepositoryTrigger-1.html">RepositoryTrigger&lt;T&gt;</a>.</p>
<h3 id="execute-custom-business-logic">Execute custom business logic</h3>
<p>XData has many features targeting this technology as not only ORM, but a full featured Data Access Layer. This is one of this features.</p>
<p>Custom logic defined as public property of <a class="xref" href="../api/XData.XDataLogic-1.html">XDataLogic&lt;T&gt;</a> class descendant with type of <a class="xref" href="../api/XData.CustomLogic-1.html">CustomLogic&lt;T&gt;</a>.</p>
<pre><code class="lang-csharp">    public class InvoiceLogic : XDataLogic&lt;Invoice&gt;
    {
        public CustomLogic&lt;Invoice&gt; TestCustomLogic =&gt; (objects =&gt; {
            Log.Write(MessageType.Information, 
                () =&gt; $&quot;TestCustomLogic called with {objects.Length} objects&quot;); 
            foreach (var invoice in objects)
            {
                var i = invoice;
                invoice.PostData(&quot;testPost&quot;, 
                    () =&gt; Encoding.UTF8.GetBytes(i.DocNumb));
                var p = Encoding.UTF8.GetBytes(i.DocNumb);
                var r = i.Callback(&quot;testCall&quot;, ref p);
                Log.Write(MessageType.Information, () =&gt;
                    @$&quot;Call for \&quot;{i.DocNumb}\&quot; returned \&quot;{r}\&quot; 
                with data \&quot;{(p == null ? null : Encoding.UTF8.GetString(p))}\&quot;&quot;);
            }
            return true;
        });
    }

    ...

    //Call example logic
    var random = new Random();
    return dataScope.GetRepository&lt;Invoice&gt;().ToArray().Execute(() =&gt; &quot;TestCustomLogic&quot;,
                &quot;testPost&quot;.SetValue((Action&lt;byte[]&gt;)(data =&gt; 
                    Console.WriteLine(&quot;Post message received (data=\&quot;{0}\&quot;)&quot;, 
                        data == null ? null : Encoding.UTF8.GetString(data))))
                        .AsEnum().ToDictionary(),
                &quot;testCall&quot;.SetValue((Func&lt;byte[], byte[]&gt;)(data =&gt; {
    Console.WriteLine(&quot;Call received \&quot;{0}\&quot;)&quot;, 
        data == null ? null : Encoding.UTF8.GetString(data));
    return random.NextDouble() &gt;= 0.5 ? null : Encoding.UTF8.GetBytes(
        $&quot;reply for \&quot;{(data == null ? null : Encoding.UTF8.GetString(data))}\&quot;&quot;);
                })).AsEnum().ToDictionary());
</code></pre><p>Programmer can develope data centric logic over some of mapped objects with ability to execute this logic in the middleware layer of three-tier architecture on a dedicated server (or cluster). And this code can be simple and representable debuged in two-tier environment. Architecture can be switched by configuration! No code modification, no side effects... This feature is linked with <a href="trigger_logic.html">Trigger logic</a> and reached by <a href="callback.html">Callbacks</a>.</p>
<p>When code is organized using data mapping modules, data logic modules and client (or Web site) it can help programmer to keep module relations clean and get ready to changes, with no matter of middleware layer existance. And this rules are not dictated, You can use it or not. You can write this logic anywhere You architect to do. Nothing will be breakes, exept of ability to use XData three-tier architecture. But if You realy don&#39;t need it, what is wrong?</p>
<h3 id="using-business-logic-callbacks">Using business logic callbacks</h3>
<p>XData alowes to use business logic callbacks to interact backend modules with frontend using synchronious <a class="xref" href="../api/XData.DataObjectExtensions.html#XData_DataObjectExtensions_Callback__1___0_System_String_System_Byte____">Callback</a> and asynchronious <a class="xref" href="../api/XData.DataObjectExtensions.html#XData_DataObjectExtensions_PostData__1___0_System_String_System_Func_System_Byte____">PostData</a> models. Synchronious calls can return result value. Callbacks can be used with <a href="../tutorial/three_tier.html">three-tier-architecture</a> as well as with client-server model. Callbacks has provided business logic clear, complete view and alowes debug same code in two-tier environment as code will be executed in three-tier.</p>
<pre><code class="lang-csharp">    public class InvoiceLogic : XDataLogic&lt;Invoice&gt;
    {
        public CustomLogic&lt;Invoice&gt; TestCustomLogic =&gt; (objects =&gt; {
            Log.Write(MessageType.Information, 
                () =&gt; $&quot;TestCustomLogic called with {objects.Length} objects&quot;); 
            foreach (var invoice in objects)
            {
                var i = invoice;
                invoice.PostData(&quot;testPost&quot;, () =&gt; Encoding.UTF8.GetBytes(i.DocNumb));
                var p = Encoding.UTF8.GetBytes(i.DocNumb);
                var r = i.Callback(&quot;testCall&quot;, ref p);
                Log.Write(MessageType.Information, () =&gt;
                    @$&quot;Call for \&quot;{i.DocNumb}\&quot; returned \&quot;{r}\&quot; with data 
\&quot;{(p == null ? null : Encoding.UTF8.GetString(p))}\&quot;&quot;);
            }
            return true;
        });
    }
</code></pre><h3 id="business-logic-calculated-fields">Business logic calculated fields</h3>
<p>XData alowed to calculate fields not only using <a href="../tutorial/mapping/static/property/property.html#sql-expression-property">SQL expressions</a>. You can subscribe <a class="xref" href="../api/XData.IRepository-1.html#XData_IRepository_1_OnInvalidateObject">OnInvalidateObject</a> event and calculate some fields on client side. More detailed events dicassed <a href="events.html">below</a>.</p>
<h3 id="using-events">Using events</h3>
<p><a href="custom_logic.html">Custom logic</a> call and <a href="trigger_logic.html">trigger logic</a> is executed on the midleware layer, deployed on the application server or not. But some reaction on data change events may be required on client side. XData has followed events to subscribe changes of data:
<a class="xref" href="../api/XData.InitRepository-1.html">InitRepository&lt;T&gt;</a> <a class="xref" href="../api/XData.IRepository-1.html#XData_IRepository_1_OnInit">OnInit</a> - event acquired when repository has been initialized
<a class="xref" href="../api/XData.InitObject-1.html">InitObject&lt;T&gt;</a> <a class="xref" href="../api/XData.IRepository-1.html#XData_IRepository_1_OnInitObject">OnInitObject</a> - event acquired when object has been initialized by database or default values
<a class="xref" href="../api/XData.InvalidateRepository-1.html">InvalidateRepository&lt;T&gt;</a> <a class="xref" href="../api/XData.IRepository-1.html#XData_IRepository_1_OnInvalidate">OnInvalidate</a> - repository data has been requeried from database
<a class="xref" href="../api/XData.InvalidateObject-1.html">InvalidateObject&lt;T&gt;</a> <a class="xref" href="../api/XData.IRepository-1.html#XData_IRepository_1_OnInvalidateObject">OnInvalidateObject</a> - object has been changed and requeied from database
<a class="xref" href="../api/XData.CurrentObjectChanging-1.html">CurrentObjectChanging&lt;T&gt;</a> <a class="xref" href="../api/XData.IRepository-1.html#XData_IRepository_1_OnCurrentObjectChanging">OnCurrentObjectChanging</a> - current object is changing
<a class="xref" href="../api/XData.CurrentObjectChanged-1.html">CurrentObjectChanged&lt;T&gt;</a> <a class="xref" href="../api/XData.IRepository-1.html#XData_IRepository_1_OnCurrentObjectChanged">OnCurrentObjectChanged</a> - current object has been changed</p>
<h3 id="virtual-data-and-attached-handlers">Virtual data and attached handlers</h3>
<p>You can use XData as database mock engine. XData has feature to replace database interactions with attached handlers call. Virtual objects is attached to repository using <a class="xref" href="../api/XData.IRepository-1.html#XData_IRepository_1_Attach__0_XData_DataObjectState_System_Collections_Generic_IEnumerable_System_Collections_Generic_KeyValuePair_System_String_System_Object___XData_AttachedHandler__0____">Attach</a> method of <a class="xref" href="../api/XData.IRepository-1.html">IRepository&lt;T&gt;</a> interface. To detach virtual objects used <a class="xref" href="../api/XData.IRepository-1.html#XData_IRepository_1_Detach_System_Predicate__0__">Detach</a> method. Multiple virtual entities can be attached to repository as new objects using <a class="xref" href="../api/XData.IRepository-1.html#XData_IRepository_1_AttachNewObjects_System_Collections_Generic_IEnumerable__0__XData_AttachedHandler__0____">AttachNewObjects</a> method. </p>
<div class="TIP"><h5>Tip</h5><p>This method (<em>AttachNewObjects</em>) can be used to add multiple dettached objects to real repository. </p>
</div>
<p>Every virtual entity can override handlers attached to repository with their own realization using parameters of <em>AttachNewObjects</em> method or <a class="xref" href="../api/XData.IRepository-1.html#XData_IRepository_1_SetAttachedHandlers__0__XData_AttachedHandler__0____">SetAttachedHandlers</a> method call. To set repository level handlers use special overload of <a class="xref" href="../api/XData.IRepository-1.html#XData_IRepository_1_SetAttachedHandlers_XData_RepositoryAttachedHandler__0____">SetAttachedHandlers</a>. To clear attached objects You can use <a class="xref" href="../api/XData.IRepository-1.html#XData_IRepository_1_ClearAttachedObjects">ClearAttachedObjects</a> method. To help wrap handlers to abstract <a class="xref" href="../api/XData.AttachedHandler-1.html">AttachedHandler&lt;T&gt;</a> class and unwrap it back to specialized handlers XData has a wrapper class <a class="xref" href="../api/XData.RepositoryAttachedHandler-1.html">RepositoryAttachedHandler</a>.</p>
<p>Attached hendlers can have followed types (see <a class="xref" href="../api/XData.AttachedHandlerType.html">AttachedHandlerType</a>):</p>
<ul>
<li><em>OnClear</em> - (<a class="xref" href="../api/XData.ClearAttachedHandler.html">ClearAttachedHandler</a>) handler called instead of <a class="xref" href="../api/XData.IRepository.html#XData_IRepository_Clear_XData_DataSubmitFlag_">Clear</a></li>
<li><em>OnExecute</em> - (<a class="xref" href="../api/XData.ExecuteAttachedHandler-1.html">ExecuteAttachedHandler&lt;T&gt;</a>) handler called instead of <a class="xref" href="../api/XData.IRepository-1.html#XData_IRepository_1_Execute_System_String_System_Collections_Generic_IEnumerable__0__System_Collections_Generic_IDictionary_System_String_System_Action_System_Byte_____System_Collections_Generic_IDictionary_System_String_System_Func_System_Byte___System_Byte_____">Execute</a></li>
<li><em>OnGetLob</em> - (<a class="xref" href="../api/XData.GetLobAttachedHandler.html">GetLobAttachedHandler</a>) handler called instead of requesting LOB data</li>
<li><em>OnGetLobSize</em> - (<a class="xref" href="../api/XData.GetLobSizeAttachedHandler.html">GetLobSizeAttachedHandler</a>) handler called instead of requesting LOB size</li>
<li><em>OnGetXml</em> - (<a class="xref" href="../api/XData.GetXmlAttachedHandler.html">GetXmlAttachedHandler</a>) handler called instead of requesting XML data</li>
<li><em>OnLock</em> - (<a class="xref" href="../api/XData.LockAttachedHandler-1.html">LockAttachedHandler&lt;T&gt;</a>) handler called instead of <a class="xref" href="../api/XData.IRepository-1.html#XData_IRepository_1_Lock__0_">Lock</a></li>
<li><em>OnRefresh</em> - (<a class="xref" href="../api/XData.RefreshAttachedHandler-1.html">RefreshAttachedHandler&lt;T&gt;</a>) handler called instead of refreshing data</li>
<li><em>OnSetLob</em> - (<a class="xref" href="../api/XData.SetLobAttachedHandler.html">SetLobAttachedHandler</a>) handler called instead of saving LOB data</li>
<li><em>OnSetXml</em> - (<a class="xref" href="../api/XData.SetXmlAttachedHandler.html">SetXmlAttachedHandler</a>) handler called instead of saving XML data</li>
<li><em>OnSubmit</em> - (<a class="xref" href="../api/XData.SubmitAttachedHandler-1.html">SubmitAttachedHandler&lt;T&gt;</a>) handler called instead of <a class="xref" href="../api/XData.IRepository-1.html#XData_IRepository_1_Submit__0__XData_DataSubmitFlag_">Submit</a> multiple objects</li>
<li><em>OnSubmitObject</em> - (<a class="xref" href="../api/XData.SubmitObjectAttachedHandler-1.html">SubmitObjectAttachedHandler&lt;T&gt;</a>) handler called instead of submitting single object</li>
<li><em>OnSubmitQuery</em> - (<a class="xref" href="../api/XData.SubmitQueryAttachedHandler-1.html">SubmitQueryAttachedHandler&lt;T&gt;</a>) handler called instead of submitting query generation</li>
</ul>
<h3 id="transactions">Transactions</h3>
<p>XData use automatic transactions handling by default. But allows to manage transacions manually using IDataScope interface method <a class="xref" href="../api/XData.IDataScope.html#XData_IDataScope_BeginTransaction_System_Boolean_System_Data_IsolationLevel_">BeginTransaction</a> returned transaction state interface <a class="xref" href="../api/XData.Database.ITransaction.html">ITransaction</a>. Transaction state is a IDisposable object. Transaction is commited when method <a class="xref" href="../api/XData.Database.ITransaction.html#XData_Database_ITransaction_Commit">Commit</a> is called. When transaction state is disposed without call Commit method, transaction is rolled back. Transaction can be started as readonly or read/write. This depends on parameter <em>read</em> of BeginTransaction method. XData can symulationaly wrap transactions one over another. First non read only transaction is related to real database tranaction, and all wrapped transactions is related to transaction labels. When wrapped transaction is rolled back real transaction is rolled back to label only. Only rolling back the &quot;main&quot; transaction calls ROLLBACK statement over database.</p>
<h3 id="sql-hints">SQL hints</h3>
<div class="WARNING"><h5>Warning</h5><p>Before using SQL hints, be sure to use all other query optimization features. This is a &quot;double-edged weapon.&quot; You need to understand very well why you are using what hints and how it will affect performance, and also make all the necessary tests confirming the effectiveness of the changes you made!</p>
</div>
<p>XData supports using SQL hints to improve SQL query productivity. All databases supports this feature using vaious mechanics and can change various parameters of SQL execution...</p>
<p>Types of hints supported by XData for RDBMS...</p>
<h4 id="ms-sql-server">MS SQL Server</h4>
<p><a href="https://docs.microsoft.com/en-gb/sql/t-sql/queries/hints-transact-sql-query?view=sql-server-2017">Query hints</a>
<a href="https://docs.microsoft.com/en-gb/sql/t-sql/queries/hints-transact-sql-table?view=sql-server-2017">Table hints</a></p>
<h4 id="oracle">Oracle</h4>
<p><a href="https://docs.oracle.com/cd/B10500_01/server.920/a96533/hintsref.htm">Query hints</a></p>
<h4 id="mysql">MySql</h4>
<p><a href="https://dev.mysql.com/doc/refman/5.7/en/optimizer-hints.html">Query hints</a></p>
<h4 id="postgresql">PostgreSQL</h4>
<p>PostgreSQL does not support hints for queries, but <a href="https://wiki.postgresql.org/wiki/Return_more_than_one_row_of_data_from_PL/pgSQL_functions">procedures that returns <em>setof record</em></a> required declare columns definition on call (see example below). Of coase, this is not a SQL hint actually, but...</p>
<pre><code class="lang-sql">create or replace function GetRows(text) returns setof record as
$
declare
r record;
begin
for r in EXECUTE &#39;&#39;select * from &#39;&#39; || $1 loop
return next r;
end loop;
return;
end
$
language &#39;plpgsql&#39;;

select * from GetRows(&#39;Department&#39;) as dept(deptid int, deptname text);
</code></pre><h4 id="sqlite">SQLite</h4>
<p>SQLite does not support hints.</p>
<h4 id="using-hints-in-static-mapping">Using hints in static mapping</h4>
<p>Query hints:</p>
<pre><code class="lang-csharp">// hint for epmty string alias is applied to query
// possible to apply different hints on 
// select, insert, update, delete statements or their combination
[DataObject(&quot;T&quot;),
 Hint(&quot;&quot;, &quot;SQL_NO_CACHE&quot;, HintType.Select),
 Hint(&quot;&quot;, &quot;HIGH_PRIORITY&quot;, HintType.Select | HintType.Insert),
 ...
</code></pre><p>Table hints (MS SQL Server only):</p>
<pre><code class="lang-csharp">[DataObject(&quot;T&quot;),
 DataTable(&quot;Test&quot;, &quot;T&quot;),
 Hint(&quot;T&quot;, &quot;nolock&quot;),
 ...
</code></pre><p>Procedure hints (PostgreSQL only):</p>
<pre><code class="lang-csharp">[DataObject(&quot;T&quot;),
 Procedure(&quot;T&quot;, &quot;TestFunction9&quot;, ProcedureType.Function),
 Hint(&quot;T&quot;, &quot;Id integer, Name varchar(20)&quot;),
 Parameter(&quot;T&quot;, 1, &quot;p_id1&quot;, typeof(int), DbType.Int32),
 Parameter(&quot;T&quot;, 1, &quot;p_name1&quot;, typeof(string), DbType.String),
 Parameter(&quot;T&quot;, 1, &quot;p_id2&quot;, typeof(int), DbType.Int32), 
 Parameter(&quot;T&quot;, 1, &quot;p_name2&quot;, typeof(string), DbType.String),
 ResultSet(&quot;T&quot;, &quot;Result&quot;)]
public class PostgreSqlTestFunction9 : IDataObject
{
    [Property(&quot;T&quot;, &quot;Id&quot;, Flags = DataPropertyFlag.Id)]
    public int Id { get; set; }
    [Property(&quot;T&quot;, &quot;Name&quot;)]
    public string Name { get; set; }
}
</code></pre><h4 id="using-hints-in-dynamic-mapping-and-dynamic-queries">Using hints in dynamic mapping and dynamic queries</h4>
<p>Query hints:</p>
<pre><code class="lang-csharp">// hint for epmty string alias is applied to query
// possible to apply different hints on 
// select, insert, update, delete statements or their combination
XDataMapping.GetStructure(&quot;T&quot;, dataScope.DefaultContext)
    .Hint(&quot;&quot;, &quot;SQL_NO_CACHE&quot;, HintType.Select)
    .Hint(&quot;&quot;, &quot;HIGH_PRIORITY&quot;, HintType.Select | HintType.Insert)...
</code></pre><p>Table hints (MS SQL Server only):</p>
<pre><code class="lang-csharp">XDataMapping.GetStructure(&quot;T&quot;, dataScope.DefaultContext)
    .DataTable(&quot;Test&quot;, &quot;T&quot;)
    .Hint(&quot;T&quot;, &quot;nolock&quot;)...
</code></pre><p>Procedure hints (PostgreSQL only):</p>
<pre><code class="lang-csharp">XDataMapping.GetStructure(context: dataScope.DefaultContext)
    .Procedure(&quot;T&quot;, &quot;TestFunction8&quot;, ProcedureType.Function)
    .Hint(&quot;T&quot;, &quot;Id integer, Name varchar(20)&quot;)
    .Parameter&lt;Classifier[]&gt;(&quot;T&quot;, 1, &quot;p_tab&quot;, DbType.Object, 
        z =&gt; z.UdtDataType(null, &quot;classifier_rec&quot;), z =&gt; z.Array())
    .Select(x =&gt; new Classifier { 
        Id = x.Field&lt;int&gt;(&quot;T&quot;, &quot;Id&quot;, z =&gt; z.Key()), 
        Name = x.Field&lt;string&gt;(&quot;T&quot;, &quot;Name&quot;) })
    .AsQuery(DataScope.Layer, &quot;p_tab&quot;.SetVar(param));
</code></pre><h3 id="call-custom-sql-code">Call custom SQL code</h3>
<p>XData can help the programmer to obtain data and process it with many ways. But also we hold in mind XData is just a common tool with limited quantity of features, and some very specific (but handy and powerfull) SQL dialect constructions may be out of XData possibilities. </p>
<p>To call dialect specific SQL statements used <a class="xref" href="../api/XData.IDataScope.html">IDataScope interface</a> with methods: <a class="xref" href="../api/XData.IDataScope.html#XData_IDataScope_FillTable_XData_Database_Adapter_Query_System_Data_CommandBehavior_">FillTable</a>, <a class="xref" href="../api/XData.IDataScope.html#XData_IDataScope_ExecuteScalar__1_XData_Database_Adapter_Query_">ExecuteScalar</a> and <a class="xref" href="../api/XData.IDataScope.html#XData_IDataScope_ExecuteNonQuery_XData_Database_Adapter_Query_">ExecuteNonQuery</a>. </p>
<pre><code class="lang-csharp">const string getCoordComResourceStateChangesForCaseCommand = @&quot;
select x.ResourceCode, x.ReportedDateTime, x.UserName, x.MissionStatusCode, 
x.ResourceStatusCode
from (select h.ResourceCode, h.ReportedDateTime, h.MissionStatusCode, 
h.ResourceStatusCode,
isnull((select top(1) log.Creator from cse_CaseFolderLog_tab log with (nolock)
       where log.CallCenterId = h.CallCenterId
           and log.CaseFolderId = h.CaseFolderId and log.CaseId = h.CaseId
           and log.Created &gt;= h.ReportedDateTime
           and datediff(s, h.ReportedDateTime, log.Created) &lt;= 10
           and (charindex(case h.MissionStatusCode when &#39;---&#39; then &#39;ready&#39; 
                    else h.MissionStatusCode end, 
                    log.LogText COLLATE Latin1_General_CS_AS) &gt; 0
                or charindex(case h.MissionStatusCode when &#39;---&#39; then &#39;disconnected&#39; 
                    else h.MissionStatusCode end, 
                    log.LogText COLLATE Latin1_General_CS_AS) &gt; 0)
           and charindex(h.ResourceCode, 
            log.LogText COLLATE Latin1_General_CS_AS) &gt; 0
           and charindex(&#39;|&#39; + log.Creator + &#39;|&#39;, @IntegrationUsers) = 0
       order by log.Created )
,
(select top(1) log.Creator from cse_CaseFolderLogFinished_tab log with (nolock)
       where log.CallCenterId = h.CallCenterId
           and log.CaseFolderId = h.CaseFolderId and log.CaseId = h.CaseId
           and log.Created &gt;= h.ReportedDateTime
           and datediff(s,h.ReportedDateTime, log.Created) &lt;= 10
           and (charindex(case h.MissionStatusCode when &#39;---&#39; then &#39;ready&#39; 
                else h.MissionStatusCode end, 
                    log.LogText COLLATE Latin1_General_CS_AS) &gt; 0
                or charindex(case h.MissionStatusCode when &#39;---&#39; then &#39;disconnected&#39; 
                else h.MissionStatusCode end, 
                    log.LogText COLLATE Latin1_General_CS_AS) &gt; 0)
           and charindex(h.ResourceCode, 
                log.LogText COLLATE Latin1_General_CS_AS) &gt; 0
           and charindex(&#39;|&#39; + log.Creator + &#39;|&#39;, @IntegrationUsers) = 0
       order by log.Created )) as UserName
from res_ResourceHistory_tab h
where h.CallCenterId = @CallCenterId and h.CaseFolderId = @CaseFolderId 
and h.CaseId = @CaseId
and not exists(select 1 from sph_ResourceHistory_tab sh
    where sh.CallCenterId = h.CallCenterId and sh.CaseFolderId = h.CaseFolderId 
    and sh.CaseId = h.CaseId
    and sh.ResourceCode = h.ResourceCode 
    and (sh.MissionStatusCode = h.MissionStatusCode
        or (sh.MissionStatusCode = &#39;---&#39; 
            and sh.ResourceStatusCode = @ClosedStatusCode))
    and sh.ReportedDateTime = h.ReportedDateTime)) x 
where x.UserName is not null&quot;;

using (var dataScope = DataEngine.Value.NewDataScope(CoordComDb))
{
    return dataScope.FillTable(
        new Query(getCoordComResourceStateChangesForCaseCommand, CommandType.Text,
            new QueryParam(&quot;@CaseFolderId&quot;, caseIdentity.CaseFolderId, DbType.Int32),
            new QueryParam(&quot;@CallCenterId&quot;, caseIdentity.CallCenterId, DbType.Int32),
            new QueryParam(&quot;@CaseId&quot;, caseIdentity.CaseId, DbType.Int32),
            new QueryParam(&quot;@IntegrationUsers&quot;, $&quot;|{string.Join(&quot;|&quot;, integrationUsers)}|&quot;),
            new QueryParam(&quot;@ClosedStatusCode&quot;, closedStatusCode)
        ), CommandBehavior.SingleResult).Rows.OfType&lt;DataRow&gt;()
        .Select(x =&gt; new Tuple&lt;string, DateTime, string, string&gt;(
            x.Field&lt;string&gt;(0), x.Field&lt;DateTime&gt;(1), x.Field&lt;string&gt;(2),
            x.Field&lt;string&gt;(3) == &quot;---&quot; ? x.Field&lt;string&gt;(4) : x.Field&lt;string&gt;(3))).ToList();
}
</code></pre><div class="TIP"><h5>Tip</h5><p>Use this mechanism with maximum care! This eliminates cross dialect approach of XData development, but we are in a real world with real programmers tasks... and we are never seen real tasks are correspond the rules of ideal programm system architecture ;) Anyway this <em>bad</em> feature is a backdoor we must provide while XData is not support all features of all specific SQL dialects.<br>
Is this realy possible?. We think that not, but we will try to provide most of nessesary features inside XData as soon as possible. We are need Your help to choose the order of features implementation and ideas to do it best!</p>
</div>
<div class="IMPORTANT"><h5>Important</h5><p>DDL instructions is not implemented by design. We believe DDL in big complicated real business application is not a thing we can delegate to &quot;dumb-metal-doll&quot;. This is why XData has no mechanics to &quot;CodeFirst&quot;... If You&#39;re task can use CodeFirst approach - use EF. This way is historically reserved by EF, and no reason to fight for it. Calling custom SQL code is a legal way to apply DDL in XData context. Programmer or database administrator write this SQL script. This code is prodused by human, real (not artifical) intellect of professional... XData only has ability to run it over database.</p>
</div>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            
            <span>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../styles/docfx.js"></script>
    <script type="text/javascript" src="../styles/main.js"></script>
  </body>
</html>
